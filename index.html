<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Kiosk</title>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            overflow: hidden;
        }
        
        html {
            height: 100%;
        }
        
        .kiosk-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .screen {
            display: none;
            height: 100%;
            padding: 20px;
            animation: slideIn 0.3s ease-out;
        }
        
        .screen.active {
            display: flex;
            flex-direction: column;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 3rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header h2 {
            font-size: 2rem;
            margin: 10px 0;
            font-weight: normal;
        }
        
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .button-grid {
            display: grid;
            gap: 20px;
            max-width: 800px;
            width: 100%;
        }
        
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        
        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .category-tab {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .category-tab:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .category-tab.active {
            background: white;
            color: #667eea;
        }
        
        .touch-button {
            background: white;
            border: none;
            border-radius: 20px;
            padding: 30px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .touch-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.3);
        }
        
        .touch-button:active {
            transform: translateY(-2px);
        }
        
        .touch-button.selected {
            background: #4CAF50;
            color: white;
        }
        
        .emoji {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .background-preview {
            width: 450px;
            height: 300px;
            border-radius: 15px;
            margin: 20px auto;
            background-size: cover;
            background-position: center;
            border: 5px solid white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            width: 100%;
            max-width: 800px;
        }
        
        .nav-button {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-button:hover {
            background: white;
            color: #667eea;
        }
        
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .quit-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #dc3545;
            border: 2px solid #dc3545;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1000;
        }
        
        .quit-button:hover {
            background: #c82333;
            border-color: #c82333;
            transform: scale(1.05);
        }
        
        .counter {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .counter-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: white;
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .counter-button:hover {
            transform: scale(1.1);
        }
        
        .counter-display {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            min-width: 100px;
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 15px;
        }
        
        .email-input {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            font-size: 1.5rem;
            border: none;
            border-radius: 15px;
            margin: 10px 0;
            text-align: center;
        }
        
        .receipt {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            margin: 20px auto;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            font-family: 'Courier New', monospace;
        }
        
        .receipt-section {
            border-bottom: 2px dashed #ccc;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        
        .receipt-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .stamp-box {
            border: 2px solid #ccc;
            width: 100px;
            height: 60px;
            display: inline-block;
            margin: 5px;
            text-align: center;
            line-height: 60px;
            font-size: 0.8rem;
        }
        
        .large-number {
            font-size: 4rem;
            font-weight: bold;
            text-align: center;
            border: 3px solid #000;
            padding: 20px;
            margin: 20px 0;
        }
        
        .camera-preview {
            width: 400px;
            height: 300px;
            background: #f0f0f0;
            border-radius: 15px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #666;
            border: 3px dashed #ccc;
            overflow: hidden;
            position: relative;
        }
        
        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
        
        .camera-canvas {
            display: none;
        }
        
        .camera-error {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        /* --- Hidden config screen + modal styles --- */
        .config-content {
            max-width: 800px;
            width: 100%;
            background: white;
            color: #222;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            text-align: left;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.6);
            z-index: 11000;
        }

        .password-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 320px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }

        .password-input {
            width: 100%;
            padding: 10px;
            font-size: 1.2rem;
            margin: 10px 0 15px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
            text-align: center;
        }

        .password-error {
            color: #c82333;
            font-weight: bold;
            margin-top: 6px;
        }
        /* Ensure nav buttons are readable on white config/modal backgrounds */
        .config-content .nav-button,
        .modal-overlay .nav-button {
            background: #667eea;
            color: white;
            border: none;
        }
        .config-content .nav-button:hover,
        .modal-overlay .nav-button:hover { background: #5560c0; }
    </style>
</head>
<body>
    <div class="kiosk-container">
        <!-- Welcome Screen -->
        <div class="screen active" id="welcome">
            <div class="header">
                <h1>üì∏ Photo Fun!</h1>
                <h2>Create Amazing Memories</h2>
            </div>
            <div class="content">
                <button class="touch-button" onclick="startSession()" style="max-width: 400px;">
                    <div class="emoji">üéâ</div>
                    <div>Start Photo Session</div>
                </button>
            </div>
        </div>
               <!-- Instructions -->
        <div class="screen" id="instructions">
            <!-- ...existing instructions content... -->
        </div>

        <!-- (Hidden demo config removed) -->

        <!-- Background Selection -->
        <div class="screen" id="background">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>Choose Your Background</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 14%"></div>
                </div>
            </div>
            <div class="content">
                <div class="background-preview" id="preview"></div>
                <div class="category-tabs" id="categoryTabs">
                    <!-- Category tabs will be populated here -->
                </div>
                <div class="button-grid grid-3" id="backgroundOptions">
                    <!-- Backgrounds will be populated here -->
                </div>
                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="nextBtn" disabled>Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- People Count -->
        <div class="screen" id="people">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>How Many People will be in the Photo?</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 28%"></div>
                </div>
            </div>
            <div class="content">
                <div class="counter">
                    <button class="counter-button" onclick="changePeople(-1)">‚àí</button>
                    <div class="counter-display" id="peopleCount">1</div>
                    <button class="counter-button" onclick="changePeople(1)">+</button>
                </div>

                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Delivery Method -->
        <div class="screen" id="delivery">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>How Do You Want Your Photos?</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 42%"></div>
                </div>
            </div>
            <div class="content">
                <div class="button-grid grid-2">
                    <button class="touch-button" onclick="selectDelivery('email')" id="emailBtn">
                        <div class="emoji">üìß</div>
                        <div>Email Me</div>
                    </button>
                    <button class="touch-button" onclick="selectDelivery('print')" id="printBtn">
                        <div class="emoji">üñ®Ô∏è</div>
                        <div>Print Photos</div>
                    </button>
                </div>
                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="deliveryNext" disabled>Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Email Count -->
        <div class="screen" id="emailCount">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>How Many Email Addresses?</h2>
                <p style="font-size: 1.2rem; margin: 10px 0; color: rgba(255,255,255,0.9);">Enter the number of email addresses you want the picture sent to.</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 56%"></div>
                </div>
            </div>
            <div class="content">
                <div class="counter">
                    <button class="counter-button" onclick="changeEmails(-1)">‚àí</button>
                    <div class="counter-display" id="emailCountDisplay">1</div>
                    <button class="counter-button" onclick="changeEmails(1)">+</button>
                </div>

                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Print Count -->
        <div class="screen" id="printCount">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>How Many Picture(s) to Print?</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 56%"></div>
                </div>
            </div>
            <div class="content">
                <div class="counter">
                    <button class="counter-button" onclick="changePrints(-1)">‚àí</button>
                    <div class="counter-display" id="printCountDisplay">1</div>
                    <button class="counter-button" onclick="changePrints(1)">+</button>
                </div>

                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Payment Method -->
        <div class="screen" id="payment">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>Payment Method</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 70%"></div>
                </div>
            </div>
            <div class="content">
                <div class="button-grid grid-3">
                    <button class="touch-button" onclick="selectPayment('cash')" id="cashBtn">
                        <div class="emoji">üíµ</div>
                        <div>Cash</div>
                    </button>
                    <button class="touch-button" onclick="selectPayment('card')" id="cardBtn">
                        <div class="emoji">üí≥</div>
                        <div>Credit/Debit</div>
                    </button>
                    <button class="touch-button" onclick="selectPayment('check')" id="checkBtn">
                        <div class="emoji">üìù</div>
                        <div>Check</div>
                    </button>
                </div>
                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="paymentNext" disabled>Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Name Entry -->
        <div class="screen" id="nameEntry">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>Enter Your Name</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 84%"></div>
                </div>
            </div>
            <div class="content">
                <input type="text" class="email-input" id="customerName" placeholder="Your Name" maxlength="50">

                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="nameNext" disabled>Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Email Entry -->
        <div class="screen" id="emailEntry">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>Enter Email Addresses</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 90%"></div>
                </div>
            </div>
            <div class="content">
                <div id="emailInputs">
                    <!-- Email inputs will be generated here -->
                </div>
                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="emailNext" disabled>Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Camera -->
        <div class="screen" id="camera">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>Take Your Photo!</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 95%"></div>
                </div>
            </div>
            <div class="content">
                <div class="camera-preview" id="cameraPreview">
                    <video id="cameraVideo" class="camera-video" autoplay muted playsinline style="display: none;"></video>
                    <canvas id="cameraCanvas" class="camera-canvas"></canvas>
                    <div id="cameraPlaceholder" class="camera-error">
                        <span>üì∏ Camera Preview<br>Smile! üòä</span>
                    </div>
                </div>
                <div class="button-grid grid-2">
                    <button class="touch-button" onclick="takePhoto()">
                        <div class="emoji">üì∏</div>
                        <div>Take Photo</div>
                    </button>
                    <button class="touch-button" onclick="retakePhoto()" id="retakeBtn" style="display: none;">
                        <div class="emoji">üîÑ</div>
                        <div>Retake</div>
                    </button>
                </div>
                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="cameraNext" disabled>Finish ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Receipt -->
        <div class="screen" id="receipt">
            <div class="header">
                <h1>üéâ All Done!</h1>
                <h2>Here's Your Receipt</h2>
            </div>
            <div class="content" style="overflow-y: auto; justify-content: flex-start; padding-top: 0;">
                <div class="receipt">
                    <!-- Customer Copy -->
                    <div class="receipt-section">
                        <h3 style="text-align: center; margin-top: 0;">CUSTOMER COPY - KEEP THIS!</h3>
                        
                        <div style="background: #f0f0f0; padding: 15px; margin: 15px 0; border-radius: 5px;">
                            <strong>üìã INSTRUCTIONS:</strong><br>
                            ‚Ä¢ Return at end of event to collect prints<br>
                            ‚Ä¢ Bring this receipt for pickup<br>
                            ‚Ä¢ Photos emailed within 24 hours<br>
                        </div>
                        
                        <p><strong>Event:</strong> <span id="receiptEvent">Spring Festival 2024</span></p>
                        <p><strong>Customer:</strong> <span id="receiptName"></span></p>
                        <p><strong>Customer #:</strong> <span id="receiptNumber"></span></p>
                        <p><strong>Date:</strong> <span id="receiptDate"></span></p>
                        <p><strong>Time:</strong> <span id="receiptTime"></span></p>
                        <p><strong>Prints:</strong> <span id="receiptPrints"></span></p>
                        <p><strong>Emails:</strong> <span id="receiptEmails"></span></p>
                        <p><strong>Payment:</strong> <span id="receiptPayment"></span></p>
                        
                        <div style="margin: 20px 0;">
                            <strong>Payment Verified:</strong>
                            <div class="stamp-box">PAID</div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <strong>Prints Collected:</strong>
                            <div class="stamp-box">PICKUP</div>
                        </div>
                        
                        <div style="font-size: 0.9rem; margin-top: 20px;">
                            <strong>üìß Email Issues?</strong> Contact: photos@event.com<br>
                            <strong>üìû Questions?</strong> Call: 1-800-PHOTOS<br>
                            <strong>üí¨ Feedback:</strong> ________________
                        </div>
                    </div>
                    
                    <!-- Operator Copy -->
                    <div class="receipt-section">
                        <h3 style="text-align: center; margin-top: 0;">OPERATOR COPY</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                            <div><strong>Customer:</strong> <span id="opName"></span></div>
                            <div><strong>Customer #:</strong> <span id="opCustomerId"></span></div>
                            <div><strong>Delivery:</strong> <span id="opDelivery"></span></div>
                            <div><strong>Date:</strong> <span id="opDate"></span></div>
                            <div><strong>Time:</strong> <span id="opTime"></span></div>
                            <div><strong>People:</strong> <span id="opPeople"></span></div>
                            <div><strong>Background:</strong> <span id="opBackground"></span></div>
                            <div><strong>Prints:</strong> <span id="opPrints"></span></div>
                            <div><strong>Emails:</strong> <span id="opEmailCount"></span></div>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <strong>Email Addresses:</strong><br>
                            <div id="opEmailList" style="font-size: 0.8rem;"></div>
                        </div>
                        
                        <div class="large-number" id="photoNumber">001</div>
                        
                        <div style="margin: 15px 0;">
                            <strong>Notes:</strong><br>
                            <div style="border: 1px solid #ccc; height: 40px; margin-top: 5px;"></div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 20px;">
                            <div class="stamp-box">PAID</div>
                            <div class="stamp-box">PHOTO</div>
                            <div class="stamp-box">EMAIL</div>
                            <div class="stamp-box">PRINT</div>
                            <div class="stamp-box">PICKUP</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #e8f5e8; padding: 20px; border-radius: 15px; margin: 20px 0; text-align: center; border-left: 5px solid #4caf50;">
                    <h3 style="color: #2e7d32; margin: 0 0 10px 0; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        üñ®Ô∏è Receipt Printing Automatically
                    </h3>
                    <p style="margin: 0; font-size: 1.2rem; color: #333;">Your receipt is being printed now. Please collect it from the printer tray.</p>
                </div>
                
                <div class="button-grid grid-2" style="margin-top: 30px;">
                    <button class="touch-button" onclick="showScreen('instructions')">
                        <div class="emoji">üìã</div>
                        <div>View Instructions</div>
                    </button>
                    <button class="touch-button" onclick="startOver()">
                        <div class="emoji">üîÑ</div>
                        <div>New Customer</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="screen" id="instructions">
            <div class="header">
                <h1>üìã Important Instructions</h1>
                <h2>Please Read Carefully</h2>
            </div>
            <div class="content" style="justify-content: flex-start; padding-top: 20px;">
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 800px; width: 100%; box-shadow: 0 8px 20px rgba(0,0,0,0.3); margin-bottom: 30px;">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">
                        <!-- Print Instructions -->
                        <div id="printInstructions" style="display: none;">
                            <h3 style="color: #667eea; margin-top: 0; font-size: 1.8rem; display: flex; align-items: center; gap: 10px;">
                                üñ®Ô∏è Print Pickup Instructions
                            </h3>
                            <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; border-left: 5px solid #667eea;">
                                <ul style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 1.1rem;">
                                    <li><strong>Return at the end of the event</strong> to collect your printed photos</li>
                                    <li><strong>Bring this receipt</strong> - you'll need it for pickup</li>
                                    <li><strong>Look for the "Photo Pickup" station</strong> near the exit</li>
                                    <li><strong>Photos will be ready 30 minutes before event ends</strong></li>
                                    <li><strong>Lost receipt?</strong> Provide your name and customer number</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Email Instructions -->
                        <div id="emailInstructions" style="display: none;">
                            <h3 style="color: #667eea; margin-top: 0; font-size: 1.8rem; display: flex; align-items: center; gap: 10px;">
                                üìß Email Delivery Instructions
                            </h3>
                            <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; border-left: 5px solid #667eea;">
                                <ul style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 1.1rem;">
                                    <li><strong>Photos will be emailed within 24 hours</strong> of the event</li>
                                    <li><strong>Check your spam/junk folder</strong> if you don't see the email</li>
                                    <li><strong>High-resolution photos</strong> will be included for printing</li>
                                    <li><strong>Email issues?</strong> Contact photos@event.com</li>
                                    <li><strong>Download within 30 days</strong> - links expire after that</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- General Instructions -->
                    <div style="background: #fff8e1; padding: 25px; border-radius: 10px; border-left: 5px solid #ffa726; margin-bottom: 30px;">
                        <h3 style="color: #f57c00; margin-top: 0; font-size: 1.8rem; display: flex; align-items: center; gap: 10px;">
                            ‚ö†Ô∏è Important Reminders
                        </h3>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 1.1rem; color: #333;">
                            <li><strong>Keep your receipt safe</strong> - it contains your customer number</li>
                            <li><strong>Payment has been processed</strong> - no additional charges</li>
                            <li><strong>Questions or issues?</strong> Find a staff member with a "Photo Helper" badge</li>
                            <li><strong>Event photos are private</strong> - only sent to addresses you provided</li>
                        </ul>
                    </div>

                    <!-- Contact Information -->
                    <div style="background: #e8f5e8; padding: 25px; border-radius: 10px; border-left: 5px solid #4caf50;">
                        <h3 style="color: #2e7d32; margin-top: 0; font-size: 1.8rem; display: flex; align-items: center; gap: 10px;">
                            üìû Need Help?
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 1.1rem; color: #333;">
                            <div>
                                <strong>üìß Email Support:</strong><br>
                                photos@event.com
                            </div>
                            <div>
                                <strong>üìû Phone Support:</strong><br>
                                1-800-PHOTOS
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-grid grid-2" style="max-width: 600px;">
                    <button class="touch-button" onclick="goBack()">
                        <div class="emoji">‚Üê </div>
                        <div>Back to Receipt</div>
                    </button>
                    <button class="touch-button" onclick="startOver()">
                        <div class="emoji">üîÑ</div>
                        <div>New Customer</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Hidden Configuration Screen (password protected via 5 taps) -->
        <div class="screen" id="config">
            <button class="quit-button" onclick="showScreen('welcome')">‚úï Close</button>
            <div class="header">
                <h1>‚öôÔ∏è Configuration</h1>
                <h2>Hidden settings</h2>
            </div>
            <div class="content" style="justify-content: flex-start; padding-top: 20px;">
                <div class="config-content">
                    <p><strong>Event Name:</strong> <input id="cfgEventName" type="text" value="Spring Festival 2024" style="width:60%"></p>
                    <p><strong>Price (USD):</strong> $<input id="cfgPrice" type="number" step="0.01" value="15.00" style="width:120px"> <small style="color:#666">(set 0 for free)</small></p>
                    <p style="margin-top:8px;"><strong>Max Prints:</strong> <input id="cfgMaxPrints" type="number" value="10" style="width:80px"></p>
                    <p><strong>Max Emails:</strong> <input id="cfgMaxEmails" type="number" value="5" style="width:80px"></p>

                    <fieldset style="border:1px solid #eee; padding:10px; border-radius:8px; margin-top:12px;">
                        <legend><strong>Payment Methods</strong></legend>
                        <label style="margin-right:12px;"><input type="checkbox" id="cfgPay_cash"> Cash</label>
                        <label style="margin-right:12px;"><input type="checkbox" id="cfgPay_card"> Credit/Debit</label>
                        <label style="margin-right:12px;"><input type="checkbox" id="cfgPay_check"> Check</label>
                    </fieldset>

                    <fieldset style="border:1px solid #eee; padding:10px; border-radius:8px; margin-top:12px;">
                        <legend><strong>Delivery Methods</strong></legend>
                        <label style="margin-right:12px;"><input type="checkbox" id="cfgDel_email"> Email</label>
                        <label style="margin-right:12px;"><input type="checkbox" id="cfgDel_print"> Print</label>
                    </fieldset>

                    <div style="margin-top:12px;">
                        <strong>Background Pictures</strong>
                        <div id="cfgBackgroundList" style="max-height:220px; overflow:auto; border:1px solid #f0f0f0; padding:8px; margin-top:6px; border-radius:6px;"></div>
                        <small style="color:#666; display:block; margin-top:6px;">Check to include a background in the chooser.</small>
                    </div>

                    <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">
                        <button class="nav-button" onclick="applyConfig()">Save</button>
                        <button class="nav-button" onclick="restoreDefaults()">Restore Defaults</button>
                        <button class="nav-button" onclick="showScreen('welcome')">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration (would be loaded from external file)
        const config = {
            eventName: "Spring Festival 2024",
            price: 15.00,
            paymentMethods: ['cash', 'card', 'check'],
            deliveryMethods: ['email', 'print'],
            maxPrints: 10,
            maxEmails: 5,
            backgroundCategories: {
                "Nature": [
                    { id: 2, name: "Sunset Beach", imageUrl: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="Sunset Beach">` },
                    { id: 3, name: "Forest Magic", imageUrl: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="Forest Magic">` },
                    { id: 4, name: "Mountain View", imageUrl: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="Mountain View">` },
                    { id: 5, name: "Ocean Waves", imageUrl: "https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="Ocean Waves">` }
                ],

                "Fun Backgrounds": [
                    { id: 11, name: "Neon Lights", preview: `<svg width="60" height="40" viewBox="0 0 60 40"><defs><filter id="glow"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><rect width="60" height="40" fill="#0a0a0a"/><rect x="5" y="5" width="50" height="6" fill="#ff0080" filter="url(#glow)" opacity="0.8"/><rect x="8" y="15" width="44" height="4" fill="#00ff80" filter="url(#glow)" opacity="0.9"/><rect x="3" y="25" width="54" height="5" fill="#0080ff" filter="url(#glow)" opacity="0.7"/><rect x="10" y="33" width="40" height="3" fill="#ffff00" filter="url(#glow)" opacity="0.8"/><circle cx="15" cy="8" r="2" fill="#ff4080" filter="url(#glow)"/><circle cx="45" cy="18" r="1.5" fill="#80ff40" filter="url(#glow)"/><circle cx="25" cy="28" r="2.5" fill="#4080ff" filter="url(#glow)"/></svg>`, fullPreview: `<svg width="300" height="200" viewBox="0 0 300 200"><defs><filter id="glowFull"><feGaussianBlur stdDeviation="4" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><rect width="300" height="200" fill="#0a0a0a"/><rect x="20" y="20" width="260" height="25" fill="#ff0080" filter="url(#glowFull)" opacity="0.8"/><rect x="40" y="60" width="220" height="18" fill="#00ff80" filter="url(#glowFull)" opacity="0.9"/><rect x="15" y="100" width="270" height="22" fill="#0080ff" filter="url(#glowFull)" opacity="0.7"/><rect x="50" y="140" width="200" height="15" fill="#ffff00" filter="url(#glowFull)" opacity="0.8"/><circle cx="75" cy="32" r="8" fill="#ff4080" filter="url(#glowFull)"/><circle cx="225" cy="70" r="6" fill="#80ff40" filter="url(#glowFull)"/><circle cx="125" cy="112" r="10" fill="#4080ff" filter="url(#glowFull)"/><circle cx="200" cy="148" r="7" fill="#ff8040" filter="url(#glowFull)"/><rect x="80" y="170" width="140" height="12" fill="#8040ff" filter="url(#glowFull)" opacity="0.8"/></svg>` },
                    { id: 13, name: "Galaxy", imageUrl: "https://images.unsplash.com/photo-1502134249126-9f3755a50d78?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1502134249126-9f3755a50d78?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="Galaxy">` },
                    { id: 14, name: "Rave", imageUrl: "https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="Rave">` }
                ],
                "Misc": [
                    { id: 15, name: "City Lights", imageUrl: "https://images.unsplash.com/photo-1514565131-fce0801e5785?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1514565131-fce0801e5785?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="City Lights">` },
                    { id: 17, name: "Elegant Black", preview: `<svg width="60" height="40" viewBox="0 0 60 40"><rect width="60" height="40" fill="#000000"/><rect x="0" y="0" width="3" height="40" fill="#808080"/><rect x="8" y="0" width="3" height="40" fill="#808080"/><rect x="16" y="0" width="3" height="40" fill="#808080"/><rect x="24" y="0" width="3" height="40" fill="#808080"/><rect x="32" y="0" width="3" height="40" fill="#808080"/><rect x="40" y="0" width="3" height="40" fill="#808080"/><rect x="48" y="0" width="3" height="40" fill="#808080"/><rect x="56" y="0" width="3" height="40" fill="#808080"/></svg>` },
                    { id: 18, name: "Custom Upload", preview: `<svg width="60" height="40" viewBox="0 0 60 40"><rect width="60" height="40" fill="#f0f0f0" stroke="#ccc" stroke-width="1"/><path d="M30,10 L35,20 L25,20 Z" fill="#666"/><rect x="25" y="20" width="10" height="8" fill="#666"/><text x="30" y="35" text-anchor="middle" fill="#000000" font-size="6">Upload</text></svg>` }
                ]
            }
        };

        // persisted operator config (background inclusion, payment/delivery enable)
        const STORAGE_KEY = 'kiosk_config_v1';

        function loadSavedConfig() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const saved = JSON.parse(raw);
                // copy relevant keys if present
                if (saved.eventName) config.eventName = saved.eventName;
                if (typeof saved.price === 'number') config.price = saved.price;
                if (Number.isInteger(saved.maxPrints)) config.maxPrints = saved.maxPrints;
                if (Number.isInteger(saved.maxEmails)) config.maxEmails = saved.maxEmails;
                if (Array.isArray(saved.paymentMethods)) config.paymentMethods = saved.paymentMethods;
                if (Array.isArray(saved.deliveryMethods)) config.deliveryMethods = saved.deliveryMethods;
                if (saved.enabledBackgrounds) {
                    // map of id -> boolean
                    window.enabledBackgrounds = saved.enabledBackgrounds;
                }
            } catch (e) {
                console.warn('Failed to load saved config', e);
            }
        }

        function saveConfigToStorage() {
            try {
                const toSave = {
                    eventName: config.eventName,
                    price: config.price,
                    maxPrints: config.maxPrints,
                    maxEmails: config.maxEmails,
                    paymentMethods: config.paymentMethods,
                    deliveryMethods: config.deliveryMethods,
                    enabledBackgrounds: window.enabledBackgrounds || {}
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
            } catch (e) {
                console.warn('Failed to save config', e);
            }
        }

        // When the config screen opens, populate inputs from runtime config
        function populateConfigUI() {
            document.getElementById('cfgEventName').value = config.eventName || '';
            document.getElementById('cfgPrice').value = (typeof config.price === 'number') ? config.price.toFixed(2) : '';
            document.getElementById('cfgMaxPrints').value = config.maxPrints || 0;
            document.getElementById('cfgMaxEmails').value = config.maxEmails || 0;

            // payment methods checkboxes
            document.getElementById('cfgPay_cash').checked = config.paymentMethods.includes('cash');
            document.getElementById('cfgPay_card').checked = config.paymentMethods.includes('card');
            document.getElementById('cfgPay_check').checked = config.paymentMethods.includes('check');

            // delivery methods
            document.getElementById('cfgDel_email').checked = config.deliveryMethods.includes('email');
            document.getElementById('cfgDel_print').checked = config.deliveryMethods.includes('print');

            // build background list with current enabled state
            buildCfgBackgroundList();
        }

        // Create background checklist inside config screen
        function buildCfgBackgroundList() {
            const container = document.getElementById('cfgBackgroundList');
            container.innerHTML = '';
            // ensure enabledBackgrounds exists
            window.enabledBackgrounds = window.enabledBackgrounds || {};

            Object.keys(config.backgroundCategories).forEach(cat => {
                const heading = document.createElement('div');
                heading.style.marginTop = '8px';
                heading.innerHTML = `<strong>${cat}</strong>`;
                container.appendChild(heading);

                config.backgroundCategories[cat].forEach(bg => {
                    const id = String(bg.id);
                    const row = document.createElement('label');
                    row.style.display = 'flex';
                    row.style.alignItems = 'center';
                    row.style.gap = '8px';
                    row.style.margin = '6px 0';

                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.dataset.bgId = id;
                    // default to true unless explicitly disabled
                    cb.checked = (window.enabledBackgrounds[id] === undefined) ? true : !!window.enabledBackgrounds[id];
                    cb.addEventListener('change', function () {
                        window.enabledBackgrounds[id] = cb.checked;
                    });

                    const preview = document.createElement('div');
                    preview.innerHTML = bg.preview || '';
                    preview.style.width = '60px';
                    preview.style.height = '40px';
                    preview.style.display = 'inline-block';

                    const labelText = document.createElement('div');
                    labelText.textContent = bg.name;

                    row.appendChild(cb);
                    row.appendChild(preview);
                    row.appendChild(labelText);
                    container.appendChild(row);
                });
            });
        }

        // Session data
        let session = {
            background: null,
            people: 1,
            delivery: null,
            emailCount: 1,
            printCount: 1,
            payment: null,
            name: '',
            emails: [],
            customerNumber: null,
            photoTaken: false,
            photoData: null
        };

        let currentScreen = 'welcome';
        let photoCounter = 1;
        let currentCategory = 'Nature';

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
            // If opening config, populate its inputs from runtime config
            if (screenId === 'config') populateConfigUI();
            // Setup instructions screen based on delivery method
            if (screenId === 'instructions') {
                setupInstructionsScreen();
            }
            // Update payment/delivery buttons when showing their screens
            if (screenId === 'delivery' || screenId === 'payment' || screenId === 'background') {
                updateMethodButtons();
            }
        }
        
        function setupInstructionsScreen() {
            const printInstructions = document.getElementById('printInstructions');
            const emailInstructions = document.getElementById('emailInstructions');
            
            // Show relevant instructions based on delivery method
            if (session.delivery === 'print') {
                printInstructions.style.display = 'block';
                emailInstructions.style.display = 'none';
            } else if (session.delivery === 'email') {
                printInstructions.style.display = 'none';
                emailInstructions.style.display = 'block';
            } else {
                // Show both if somehow both are selected (shouldn't happen)
                printInstructions.style.display = 'block';
                emailInstructions.style.display = 'block';
            }
        }
        
        // Camera functions
        let cameraStream = null;
        
        async function initializeCamera() {
            const video = document.getElementById('cameraVideo');
            const placeholder = document.getElementById('cameraPlaceholder');
            
            try {
                // Request camera access
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    } 
                });
                
                video.srcObject = cameraStream;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                
            } catch (error) {
                console.error('Camera access denied or not available:', error);
                placeholder.innerHTML = '<span>üì∏ Camera not available<br>Please allow camera access</span>';
                placeholder.style.background = '#ffe6e6';
            }
        }
        
        function stopCamera() {
            const video = document.getElementById('cameraVideo');
            const placeholder = document.getElementById('cameraPlaceholder');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.style.display = 'none';
            video.srcObject = null;
            
            if (placeholder) {
                placeholder.style.display = 'flex';
                placeholder.innerHTML = '<span>üì∏ Camera Preview<br>Smile! üòä</span>';
                placeholder.style.background = '#f0f0f0';
            }
        }

        function startSession() {
            // Reset all session data for new customer
            session = {
                background: null,
                people: 1,
                delivery: null,
                emailCount: 1,
                printCount: 1,
                payment: null,
                name: '',
                emails: [],
                customerNumber: 'PH' + Date.now().toString().slice(-6),
                photoTaken: false
            };
            
            // Reset all UI elements
            resetAllUI();
            
            loadBackgrounds();
            showScreen('background');
        }
        


        function goBack() {
            const screens = ['welcome', 'background', 'people', 'delivery', 'emailCount', 'printCount', 'payment', 'nameEntry', 'emailEntry', 'camera', 'receipt', 'instructions'];
            const currentIndex = screens.indexOf(currentScreen);
            
            if (currentIndex > 0) {
                let prevScreen = screens[currentIndex - 1];
                
                // Skip screens based on delivery method
                if (prevScreen === 'emailCount' && session.delivery !== 'email') {
                    prevScreen = screens[currentIndex - 2];
                }
                if (prevScreen === 'printCount' && session.delivery !== 'print') {
                    prevScreen = screens[currentIndex - 2];
                }
                if (prevScreen === 'emailEntry' && session.delivery !== 'email') {
                    prevScreen = 'nameEntry';
                }
                
                showScreen(prevScreen);
            }
        }

        function nextStep() {
            const screens = {
                'background': 'people',
                'people': 'delivery',
                'delivery': session.delivery === 'email' ? 'emailCount' : 'printCount',
                'emailCount': 'payment',
                'printCount': 'payment',
                'payment': 'nameEntry',
                'nameEntry': session.delivery === 'email' ? 'emailEntry' : 'camera',
                'emailEntry': 'camera',
                'camera': 'receipt'
            };
            
            if (screens[currentScreen]) {
                showScreen(screens[currentScreen]);
                
                // Setup next screen
                if (screens[currentScreen] === 'emailEntry') {
                    setupEmailInputs();
                } else if (screens[currentScreen] === 'camera') {
                    initializeCamera();
                } else if (screens[currentScreen] === 'receipt') {
                    generateReceipt();
                }
            }
        }

        // Background selection
        function loadBackgrounds() {
            loadCategoryTabs();
            loadBackgroundsForCategory(currentCategory);
        }
        
        function loadCategoryTabs() {
            const tabsContainer = document.getElementById('categoryTabs');
            tabsContainer.innerHTML = '';
            
            Object.keys(config.backgroundCategories).forEach(category => {
                const tab = document.createElement('button');
                tab.className = 'category-tab';
                tab.textContent = category;
                tab.onclick = () => selectCategory(category);
                
                if (category === currentCategory) {
                    tab.classList.add('active');
                }
                
                tabsContainer.appendChild(tab);
            });
        }
        
        function selectCategory(category) {
            currentCategory = category;
            
            // Update tab states
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load backgrounds for selected category
            loadBackgroundsForCategory(category);
        }
        
        function loadBackgroundsForCategory(category) {
            const container = document.getElementById('backgroundOptions');
            container.innerHTML = '';
            
            const backgrounds = config.backgroundCategories[category];
            // Respect enabledBackgrounds map (if a background id key is present and false,
            // skip showing that background in the chooser)
            const enabled = window.enabledBackgrounds || {};

            backgrounds.forEach(bg => {
                if (enabled[String(bg.id)] === false) return; // skip disabled backgrounds
                const button = document.createElement('button');
                button.className = 'touch-button';
                button.onclick = () => selectBackground(bg);
                
                button.innerHTML = `
                    <div style="width: 60px; height: 40px; border-radius: 8px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;">${bg.preview}</div>
                    <div>${bg.name}</div>
                `;
                
                container.appendChild(button);
            });
        }

        function selectBackground(bg) {
            session.background = bg;
            
            // Update preview
            const preview = document.getElementById('preview');
            preview.style.background = 'none';
            
            if (bg.id === 18) {
                showCustomBackgroundInstructions();
            } else if (bg.imageUrl) {
                // Use real image for preview
                preview.innerHTML = `<img src="${bg.imageUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'padding: 20px; text-align: center; color: #666;\\'>Image Preview</div>';" alt="${bg.name}">`;
            } else {
                // Use full preview if available, otherwise scale up the regular preview
                const previewContent = bg.fullPreview || bg.preview.replace('width="60" height="40"', 'width="280" height="180"');
                preview.innerHTML = `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; border-radius: 10px; overflow: hidden;">${previewContent}</div>`;
            }
            
            // Update button states
            document.querySelectorAll('#backgroundOptions .touch-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.closest('.touch-button').classList.add('selected');
            
            document.getElementById('nextBtn').disabled = false;
        }

        function showCustomBackgroundInstructions() {
            const preview = document.getElementById('preview');
            preview.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">üìã Give this number to the photographer:<br><strong style="font-size: 2rem;">' + session.customerNumber + '</strong></div>';
        }

        // People counter
        function changePeople(delta) {
            session.people = Math.max(1, Math.min(20, session.people + delta));
            document.getElementById('peopleCount').textContent = session.people;
        }

        // Delivery selection
        function selectDelivery(method) {
            session.delivery = method;
            
            document.querySelectorAll('#delivery .touch-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            if (method === 'email') {
                document.getElementById('emailBtn').classList.add('selected');
            } else {
                document.getElementById('printBtn').classList.add('selected');
            }
            
            document.getElementById('deliveryNext').disabled = false;
        }

        // Email counter
        function changeEmails(delta) {
            session.emailCount = Math.max(1, Math.min(config.maxEmails, session.emailCount + delta));
            document.getElementById('emailCountDisplay').textContent = session.emailCount;
        }

        // Print counter
        function changePrints(delta) {
            session.printCount = Math.max(1, Math.min(config.maxPrints, session.printCount + delta));
            document.getElementById('printCountDisplay').textContent = session.printCount;
        }

        // Payment selection
        function selectPayment(method) {
            session.payment = method;
            
            document.querySelectorAll('#payment .touch-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            if (method === 'cash') {
                document.getElementById('cashBtn').classList.add('selected');
            } else if (method === 'card') {
                document.getElementById('cardBtn').classList.add('selected');
            } else if (method === 'check') {
                document.getElementById('checkBtn').classList.add('selected');
            }
            
            document.getElementById('paymentNext').disabled = false;
        }

        // Name entry
        document.getElementById('customerName').addEventListener('input', function() {
            session.name = this.value.trim();
            document.getElementById('nameNext').disabled = session.name.length === 0;
        });

        // Email entry
        function setupEmailInputs() {
            const container = document.getElementById('emailInputs');
            container.innerHTML = '';
            session.emails = [];
            
            for (let i = 0; i < session.emailCount; i++) {
                const input = document.createElement('input');
                input.type = 'email';
                input.className = 'email-input';
                input.placeholder = `Email ${i + 1}`;
                input.addEventListener('input', validateEmails);
                container.appendChild(input);
            }
        }

        function validateEmails() {
            const inputs = document.querySelectorAll('#emailInputs input');
            session.emails = [];
            let allValid = true;
            
            // Email validation regex pattern
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            inputs.forEach(input => {
                const email = input.value.trim();
                
                // Reset input styling
                input.style.borderColor = '';
                input.style.backgroundColor = '';
                
                if (email) {
                    if (emailPattern.test(email)) {
                        // Valid email
                        session.emails.push(email);
                        input.style.borderColor = '#4CAF50';
                        input.style.backgroundColor = '#f8fff8';
                    } else {
                        // Invalid email format
                        allValid = false;
                        input.style.borderColor = '#dc3545';
                        input.style.backgroundColor = '#fff8f8';
                    }
                } else {
                    // Empty field
                    allValid = false;
                }
            });
            
            document.getElementById('emailNext').disabled = !allValid || session.emails.length !== session.emailCount;
        }

        // Removed demo-style unlock handler. Only the modal-based 5-tap handler
        // below is used to require the password every time 5 taps are detected.
        
        // Camera
        function takePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const placeholder = document.getElementById('cameraPlaceholder');
            
            if (video.srcObject) {
                // Set canvas size to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw current video frame to canvas
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                // Convert to image data
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                session.photoData = imageData;
                
                // Show captured photo
                video.style.display = 'none';
                placeholder.style.display = 'flex';
                placeholder.innerHTML = `<img src="${imageData}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" alt="Captured Photo">`;
                placeholder.style.background = 'none';
                
                session.photoTaken = true;
                document.getElementById('retakeBtn').style.display = 'flex';
                document.getElementById('cameraNext').disabled = false;
            } else {
                // Fallback if camera not available
                session.photoTaken = true;
                placeholder.innerHTML = '<span>üì∏ Photo Captured!<br>Looking great! üòä</span>';
                placeholder.style.background = '#e8f5e8';
                document.getElementById('retakeBtn').style.display = 'flex';
                document.getElementById('cameraNext').disabled = false;
            }
        }

        function retakePhoto() {
            const video = document.getElementById('cameraVideo');
            const placeholder = document.getElementById('cameraPlaceholder');
            
            session.photoTaken = false;
            session.photoData = null;
            
            if (cameraStream) {
                video.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                placeholder.innerHTML = '<span>üì∏ Camera Preview<br>Smile! üòä</span>';
                placeholder.style.background = '#f0f0f0';
                placeholder.style.display = 'flex';
            }
            
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('cameraNext').disabled = true;
        }

        // Receipt generation
        function generateReceipt() {
            const now = new Date();
            const date = now.toLocaleDateString();
            const time = now.toLocaleTimeString();
            
            // Customer copy
            document.getElementById('receiptEvent').textContent = config.eventName;
            document.getElementById('receiptName').textContent = session.name;
            document.getElementById('receiptNumber').textContent = session.customerNumber;
            document.getElementById('receiptDate').textContent = date;
            document.getElementById('receiptTime').textContent = time;
            document.getElementById('receiptPrints').textContent = session.delivery === 'print' ? session.printCount : '0';
            document.getElementById('receiptEmails').textContent = session.delivery === 'email' ? session.emailCount : '0';
            document.getElementById('receiptPayment').textContent = session.payment.toUpperCase();
            
            // Operator copy
            document.getElementById('opName').textContent = session.name;
            document.getElementById('opCustomerId').textContent = session.customerNumber;
            document.getElementById('opDelivery').textContent = session.delivery.toUpperCase();
            document.getElementById('opDate').textContent = date;
            document.getElementById('opTime').textContent = time;
            document.getElementById('opPeople').textContent = session.people;
            document.getElementById('opBackground').textContent = session.background.id;
            document.getElementById('opPrints').textContent = session.delivery === 'print' ? session.printCount : '0';
            document.getElementById('opEmailCount').textContent = session.delivery === 'email' ? session.emailCount : '0';
            document.getElementById('photoNumber').textContent = String(photoCounter).padStart(3, '0');
            
            if (session.delivery === 'email') {
                document.getElementById('opEmailList').innerHTML = session.emails.map(email => `‚Ä¢ ${email}`).join('<br>');
            } else {
                document.getElementById('opEmailList').textContent = 'N/A';
            }
            
            photoCounter++;
        }

        function printReceipt() {
            // In a real implementation, this would send to printer
            const customModal = document.createElement('div');
            customModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 10000;
            `;
            customModal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px;">
                    <h3 style="margin-top: 0;">üìÑ Receipt Sent!</h3>
                    <p>Receipt sent to printer! Please collect from the printer tray.</p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: #667eea; color: white; border: none; padding: 10px 20px; 
                                   border-radius: 8px; cursor: pointer; font-size: 1rem;">OK</button>
                </div>
            `;
            document.body.appendChild(customModal);
        }

        function resetAllUI() {
            // Reset all button selections
            document.querySelectorAll('.touch-button').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
            
            // Reset navigation buttons
            document.querySelectorAll('.nav-button').forEach(btn => btn.disabled = false);
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('deliveryNext').disabled = true;
            document.getElementById('paymentNext').disabled = true;
            document.getElementById('nameNext').disabled = true;
            document.getElementById('emailNext').disabled = true;
            document.getElementById('cameraNext').disabled = true;
            
            // Reset form inputs
            document.getElementById('customerName').value = '';
            document.getElementById('peopleCount').textContent = '1';
            document.getElementById('emailCountDisplay').textContent = '1';
            document.getElementById('printCountDisplay').textContent = '1';
            
            // Reset background preview
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            preview.style.background = 'none';
            
            // Reset camera preview
            stopCamera();
            const placeholder = document.getElementById('cameraPlaceholder');
            if (placeholder) {
                placeholder.innerHTML = '<span>üì∏ Camera Preview<br>Smile! üòä</span>';
                placeholder.style.background = '#f0f0f0';
                placeholder.style.display = 'flex';
            }
            document.getElementById('retakeBtn').style.display = 'none';
            
            // Reset email inputs container
            const emailInputs = document.getElementById('emailInputs');
            if (emailInputs) {
                emailInputs.innerHTML = '';
            }
            
            // Reset category to default
            currentCategory = 'Nature';
        }

        function startOver() {
            // Reset session
            session = {
                background: null,
                people: 1,
                delivery: null,
                emailCount: 1,
                printCount: 1,
                payment: null,
                name: '',
                emails: [],
                customerNumber: null,
                photoTaken: false
            };
            
            // Reset all UI elements
            resetAllUI();
            
            showScreen('welcome');
        }

        function showHelp() {
            // In a real implementation, this might call an attendant or show help
            const customModal = document.createElement('div');
            customModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 10000;
            `;
            customModal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px;">
                    <h3 style="margin-top: 0;">üÜò Help is Coming!</h3>
                    <p>An attendant will be with you shortly! Look for someone with a "Photo Helper" badge.</p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: #667eea; color: white; border: none; padding: 10px 20px; 
                                   border-radius: 8px; cursor: pointer; font-size: 1rem;">OK</button>
                </div>
            `;
            document.body.appendChild(customModal);
        }

        function quitSession() {
            // Reset session and return to welcome screen
            session = {
                background: null,
                people: 1,
                delivery: null,
                emailCount: 1,
                printCount: 1,
                payment: null,
                name: '',
                emails: [],
                customerNumber: null,
                photoTaken: false
            };
            
            // Reset all UI elements
            resetAllUI();
            
            showScreen('welcome');
        }

        // --- Secret 5-tap (click) handler & password modal ---
        (function () {
            let secretCount = 0;
            let secretTimer = null;
            const requiredTaps = 5;
            const secretPassword = '1234';
            let modalOpen = false;

            function resetSecret() {
                secretCount = 0;
                if (secretTimer) {
                    clearTimeout(secretTimer);
                    secretTimer = null;
                }
            }

            // Listen for clicks/taps on the kiosk area. Only clicks outside
            // interactive elements increment the counter.
            document.addEventListener('click', function (ev) {
                if (modalOpen) return; // ignore while password modal is open
                // If the configuration screen is open, do NOT count taps here.
                if (currentScreen === 'config') return;
                // ignore clicks on buttons/inputs/textareas/overlays
                if (ev.target.closest && ev.target.closest('button, input, textarea, .modal-overlay, #config')) {
                    return;
                }

                secretCount++;
                if (secretTimer) clearTimeout(secretTimer);
                // reset count shortly after inactivity
                secretTimer = setTimeout(resetSecret, 500);

                if (secretCount >= requiredTaps) {
                    // require password every time: open modal and reset counter
                    resetSecret();
                    showPasswordModal();
                }
            }, true);

            function showPasswordModal() {
                modalOpen = true;
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.innerHTML = `
                    <div class="password-box" role="dialog" aria-modal="true">
                        <h3>Enter Config Password</h3>
                        <input id="secretPasswordInput" class="password-input" type="password" placeholder="Password">
                        <div style="display:flex; gap:8px; justify-content:center;">
                            <button id="secretSubmit" class="nav-button">Enter</button>
                            <button id="secretCancel" class="nav-button">Cancel</button>
                        </div>
                        <div id="secretError" class="password-error" style="display:none;">Incorrect password</div>
                    </div>
                `;
                document.body.appendChild(overlay);

                const input = document.getElementById('secretPasswordInput');
                const submit = document.getElementById('secretSubmit');
                const cancel = document.getElementById('secretCancel');
                const err = document.getElementById('secretError');

                // Autofocus
                setTimeout(() => input.focus(), 50);

                function closeModal() {
                    modalOpen = false;
                    overlay.remove();
                }

                submit.addEventListener('click', function () {
                    const val = input.value || '';
                    if (val === secretPassword) {
                        closeModal();
                        // Only after correct password do we show config
                        showScreen('config');
                        // Ensure next 5 taps require password again
                        resetSecret();
                    } else {
                        err.style.display = 'block';
                        setTimeout(() => {
                            err.style.display = 'none';
                            input.value = '';
                            input.focus();
                        }, 1200);
                    }
                });

                cancel.addEventListener('click', function () {
                    closeModal();
                    // ensure secret counter reset so password is required on next 5 taps
                    resetSecret();
                });

                // allow Enter and Escape key handling inside modal
                input.addEventListener('keyup', function (e) {
                    if (e.key === 'Enter') submit.click();
                    if (e.key === 'Escape') cancel.click();
                });

                // Global ESC handling while modal open: close modal and don't open config
                function onKeyDown(e) {
                    if (e.key === 'Escape' && modalOpen) {
                        cancel.click();
                    }
                }

                document.addEventListener('keydown', onKeyDown, { once: false });

                // When config screen is visible, ESC should close config and return to welcome
                // Add a global keydown listener that will close config if ESC pressed while
                // config is active.
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' && currentScreen === 'config') {
                        // Close config and return to welcome
                        showScreen('welcome');
                        // Also reset secret counter so next 5 taps require password
                        resetSecret();
                    }
                }, true);
            }
        })();

        // Apply config values from config screen to runtime config
        function applyConfig() {
            // Read values from config UI
            const en = document.getElementById('cfgEventName').value || config.eventName;
            const pr = parseFloat(document.getElementById('cfgPrice').value);
            const mp = parseInt(document.getElementById('cfgMaxPrints').value);
            const me = parseInt(document.getElementById('cfgMaxEmails').value);

            // Payment methods
            const pays = [];
            if (document.getElementById('cfgPay_cash').checked) pays.push('cash');
            if (document.getElementById('cfgPay_card').checked) pays.push('card');
            if (document.getElementById('cfgPay_check').checked) pays.push('check');

            // Delivery methods
            const dels = [];
            if (document.getElementById('cfgDel_email').checked) dels.push('email');
            if (document.getElementById('cfgDel_print').checked) dels.push('print');

            // Apply to runtime config (with safe fallbacks)
            config.eventName = en;
            if (!Number.isNaN(pr)) config.price = pr;
            if (Number.isInteger(mp)) config.maxPrints = mp;
            if (Number.isInteger(me)) config.maxEmails = me;

            // Ensure at least one payment/delivery remains enabled (fallback to previous)
            if (pays.length > 0) config.paymentMethods = pays;
            if (dels.length > 0) config.deliveryMethods = dels;

            // Save enabledBackgrounds map (window.enabledBackgrounds maintained by checkboxes)
            window.enabledBackgrounds = window.enabledBackgrounds || {};

            // Persist to localStorage
            saveConfigToStorage();

            // Refresh UI that depends on config
            loadBackgrounds();
            // Update visible payment/delivery buttons immediately
            if (typeof updateMethodButtons === 'function') updateMethodButtons();

            // Clamp any active session values to the new maxima
            session.printCount = Math.min(session.printCount || 1, config.maxPrints);
            session.emailCount = Math.min(session.emailCount || 1, config.maxEmails);

            // Provide feedback modal
            const m = document.createElement('div');
            m.className = 'modal-overlay';
            m.innerHTML = `<div role="dialog" aria-modal="true" style="background:white;padding:20px;border-radius:10px;text-align:center;max-width:320px;margin:auto;">
                <strong>Settings saved</strong>
                <div style="margin-top:12px;display:flex;justify-content:center;">
                    <button id="cfgSavedOk" class="nav-button">OK</button>
                </div>
            </div>`;
            document.body.appendChild(m);

            // Wire up the OK button to remove the overlay and re-enable interactions
            const okBtn = document.getElementById('cfgSavedOk');
            if (okBtn) {
                okBtn.addEventListener('click', function () {
                    m.remove();
                });
            }
            // Allow Escape key to dismiss the small modal as well
            function onSavedKey(e) {
                if (e.key === 'Escape') {
                    m.remove();
                    document.removeEventListener('keydown', onSavedKey);
                }
            }
            document.addEventListener('keydown', onSavedKey);
            }

            // Update delivery and payment buttons based on config.
            function updateMethodButtons() {
                // Delivery buttons
                const emailBtn = document.getElementById('emailBtn');
                const printBtn = document.getElementById('printBtn');
                if (emailBtn) emailBtn.style.display = config.deliveryMethods.includes('email') ? 'flex' : 'none';
                if (printBtn) printBtn.style.display = config.deliveryMethods.includes('print') ? 'flex' : 'none';

                // Payment buttons
                const cashBtn = document.getElementById('cashBtn');
                const cardBtn = document.getElementById('cardBtn');
                const checkBtn = document.getElementById('checkBtn');
                if (cashBtn) cashBtn.style.display = config.paymentMethods.includes('cash') ? 'flex' : 'none';
                if (cardBtn) cardBtn.style.display = config.paymentMethods.includes('card') ? 'flex' : 'none';
                if (checkBtn) checkBtn.style.display = config.paymentMethods.includes('check') ? 'flex' : 'none';

                // Clear invalid selections if necessary
                if (session.delivery && !config.deliveryMethods.includes(session.delivery)) {
                    session.delivery = null;
                    const dn = document.getElementById('deliveryNext'); if (dn) dn.disabled = true;
                }
                if (session.payment && !config.paymentMethods.includes(session.payment)) {
                    session.payment = null;
                    const pn = document.getElementById('paymentNext'); if (pn) pn.disabled = true;
                }

                // Update category tabs/backgrounds if needed
                loadBackgrounds();
            }

                (function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992d4c1ab31813f8',t:'MTc2MTE4MTIyNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>    </script>        }            showScreen('welcome');            // Return to welcome





            }
            (function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992d4c1ab31813f8',t:'MTc2MTE4MTIyNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>    </script>        }            showScreen('welcome');            // Return to welcome

                // Load persisted operator config and initialize background list before first render
                loadSavedConfig();
                window.enabledBackgrounds = window.enabledBackgrounds || {};
                // Preload backgrounds (so config respects enabled list even before session)
                loadBackgrounds();
                // Update method buttons to reflect persisted config
                if (typeof updateMethodButtons === 'function') updateMethodButtons();
