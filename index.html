<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Kiosk</title>
    <style>
                /* Ensure nav buttons are readable on white config/modal backgrounds */
        .config-content .nav-button,
        .modal-overlay .nav-button {
            background: #667eea;
            color: white;
            border: none;
        }
        .config-content .nav-button:hover,
        .modal-overlay .nav-button:hover { background: #5560c0; }
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            /* accessibility: base font size adjustable via JS */
            font-size: var(--app-base-font-size, 16px);
            height: 100%;
            overflow: hidden;
        }
        
        html {
            height: 100%;
        }
        
        .kiosk-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;

        }
        
        .screen {
            display: none;
            height: 100%;
            padding: 20px;
            animation: slideIn 0.3s ease-out;
        }
        
        .screen.active {
            display: flex;
            flex-direction: column;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 3rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header h2 {
            font-size: 2rem;
            margin: 10px 0;
            font-weight: normal;
        }
        
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .button-grid {
            display: grid;
            gap: 20px;
            max-width: 800px;
            width: 100%;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        
        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .category-tab {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .category-tab:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .category-tab.active {
            background: white;
            color: #667eea;
        }
        
        .touch-button {
            background: white;
            border: none;
            border-radius: 20px;
            padding: 30px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .touch-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.3);
        }
        
        .touch-button:active {
            transform: translateY(-2px);
        }
        
        .touch-button.selected {
            background: #4CAF50;
            color: white;
        }
        
        .emoji {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .background-preview {
            width: 450px;
            height: 300px;
            flex: 0 0 auto;
            border-radius: 15px;
            margin: 20px auto;
            background-size: cover;
            background-position: center;
            border: 5px solid white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        #background .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* instead of center */
            overflow-y: auto;            /* allow scrolling */
            padding-bottom: 100px;       /* space so nav buttons don't overlap */
        }

        .background-options-container {
            flex: 1 1 auto;
            width: 100%;
            max-width: 900px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }

        .background-options-container::-webkit-scrollbar {
            width: 10px;
        }

        .background-options-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.4);
            border-radius: 5px;
        }

        .navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            padding: 15px 30px;
            box-sizing: border-box;
            z-index: 2000;
            transition: transform 0.25s ease;
        }
        
        .nav-button {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-button:hover {
            background: white;
            color: #667eea;
        }
        
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .quit-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #dc3545;
            border: 2px solid #dc3545;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1000;
        }
        
        .quit-button:hover {
            background: #c82333;
            border-color: #c82333;
            transform: scale(1.05);
        }
        
        .counter {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .counter-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: white;
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .counter-button:hover {
            transform: scale(1.1);
        }
        
        .counter-display {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            min-width: 100px;
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 15px;
        }
        
        .email-input {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            font-size: 1.5rem;
            border: none;
            border-radius: 15px;
            margin: 10px 0;
            text-align: center;
        }
        
        

        .receipt {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            margin: 20px auto;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
        }
        
        .receipt-section {
            border-bottom: 2px dashed #ccc;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        
        .receipt-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .stamp-box {
            border: 2px solid #ccc;
            width: 100px;
            height: 60px;
            display: inline-block;
            margin: 5px;
            text-align: center;
            line-height: 60px;
            font-size: 0.8rem;
        }
        
        .large-number {
            font-size: 4rem;
            font-weight: bold;
            text-align: center;
            border: 3px solid #000;
            padding: 20px;
            margin: 20px 0;
        }
        
        .camera-preview {
            width: 100%;
            max-width: 600px;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 15px;
            margin: 20px auto;
            border: 3px solid #ccc;
            overflow: hidden;
            position: relative;
        }
        
        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
        
        .camera-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
        }
        
        .camera-error {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 5px;
            transition: width 0.3s ease;
        }


        #timeoutModal {
	   position: fixed;
  	   top: 0; left: 0;
  	   width: 100%; height: 100%;
  	   background: rgba(0,0,0,0.7);
  	   display: none;
  	   align-items: center;
  	   justify-content: center;
  	   z-index: 10000;
        }

        #timeoutModal .modal-content {
  	   background: white;
  	   padding: 30px;
  	   border-radius: 15px;
  	   text-align: center;
  	   max-width: 400px;
  	   font-size: 1.5rem;
         }

	#totalBox {
  	   position: fixed;
  	   top: 20px;
  	   left: 20px;
  	   background: none;
  	   color: #000;
  	   padding: 12px 20px;
  	   border-radius: 8px;
  	   font-size: 1.85rem;
  	   font-weight: 600;
  	   box-shadow: none;
  	   cursor: default;
  	   user-select: none;
  	   z-index: 3000;
	   display: none;
	}


    </style>
    <style>
        /* Config modal styles */
        .config-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.6);
            z-index: 12000;
        }
        .config-box {
            background: #fff;
            color: #222;
            padding: 22px;
            border-radius: 12px;
            position: relative;
            width: min(760px, 94%);
            max-height: 84vh;
            overflow: auto;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        .config-box h3 { margin-top: 0; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start; }
        #cfgBackgroundList { max-height: 240px; overflow: auto; border: 1px solid #eee; padding: 8px; border-radius: 6px; }
        .cfg-actions { display:flex; gap:12px; justify-content: flex-end; margin-top: 12px; }
        .config-box .nav-button { background: #667eea; color: #fff; border: none; }
        /* prominent close button for operator/password modal */
        .password-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: #c0392b;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        }
        .password-close:hover { background: #a8322a; }
    </style>
</head>
<body>
    <!-- Accessibility toggle + panel -->
    <div id="a11yToolbar" class="move-with-vk" style="position:fixed; left:12px; bottom:112px; transform:none; z-index:18000;">
        <!-- Much larger touch-friendly accessibility toggle with inline SVG (person with raised arms) -->
            <button id="a11yToggle" aria-expanded="false" aria-controls="a11yPanel" aria-label="Open accessibility options" class="nav-button" 
                style="background:#0b3b66;color:#fff;border:none;border-radius:16px;padding:8px; width:94px; height:94px; display:inline-flex; align-items:center; justify-content:center; box-shadow:0 12px 30px rgba(0,0,0,0.35); touch-action:manipulation; -webkit-tap-highlight-color: transparent;">
            <!-- Simple text icon for accessibility (text size) -->
            <span id="a11yIconText" aria-hidden="true" style="font-size:34px; font-weight:700; line-height:1; color:#fff; display:block; font-family: 'Segoe UI', Roboto, Arial, sans-serif;">aA</span>
        </button>
    <div id="a11yPanel" style="display:none; position:absolute; left:0; bottom:calc(100% + 8px); top:auto; margin-left:0; background:rgba(255,255,255,0.98); padding:8px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.18); width:160px;">
        <div style="display:flex; flex-direction:column; gap:10px; align-items:stretch; justify-content:center;">
            <button id="a11yFontDec" aria-label="Decrease font size" title="Decrease font size" class="nav-button" 
                style="background:#111;color:#fff;border:none;border-radius:10px;padding:14px;font-size:1.25rem;width:100%;min-height:56px;display:inline-flex;align-items:center;justify-content:center;touch-action:manipulation;-webkit-tap-highlight-color:transparent;">A-</button>
            <button id="a11yFontInc" aria-label="Increase font size" title="Increase font size" class="nav-button" 
                style="background:#111;color:#fff;border:none;border-radius:10px;padding:14px;font-size:1.25rem;width:100%;min-height:56px;display:inline-flex;align-items:center;justify-content:center;touch-action:manipulation;-webkit-tap-highlight-color:transparent;">A+</button>
            <button id="a11yReset" aria-label="Reset accessibility settings" title="Reset" class="nav-button" 
                style="background:#111;color:#fff;border:none;border-radius:10px;padding:12px;font-size:1.05rem;width:100%;min-height:48px;display:inline-flex;align-items:center;justify-content:center;touch-action:manipulation;-webkit-tap-highlight-color:transparent;">Reset</button>
        </div>
    </div>
        <!-- Reprint confirmation modal (demo-only) -->
        <div id="reprintModal" class="config-modal" role="dialog" aria-modal="true" style="display:none;">
            <div class="config-box" style="max-width:360px; text-align:center;">
                <h3 style="margin-top:0;">Reprint Ticket</h3>
                <p id="reprintText" style="color:#333; margin:12px 0;"></p>
                <div style="display:flex; gap:12px; justify-content:center; margin-top:12px;">
                    <button class="nav-button" onclick="confirmReprint()" style="background:#667eea; color:white; border:none;">Confirm</button>
                    <button class="nav-button" onclick="document.getElementById('reprintModal').style.display='none'" style="background:#ccc; color:#222;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- (confirmPrint moved inline into the receipt screen) -->
    
    <!-- Order confirmation screen (pre-receipt) - show only user-entered inputs -->
    <div class="screen" id="confirmOrder" style="display:none;">
        <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
        <div class="header">
            <h2>Confirm Your Order</h2>
            <div class="progress-bar"><div class="progress-fill" style="width: 100%"></div></div>
        </div>
        <div class="content" style="overflow-y:auto; justify-content:flex-start; padding-top:10px;">
            <div style="max-width:640px; width:min(92%,640px); min-height:480px; margin: 0 auto; background: white; padding:30px; border-radius:12px; color:#222; box-shadow: 0 12px 34px rgba(0,0,0,0.08); font-size:1.30rem; line-height:1.4;">
                    <h3 style="margin-top:0; font-size:1.25rem;">Confirm Your Ticket</h3>
                    <div style="display:grid; grid-template-columns: 1fr 300px; gap:12px; font-size:0.98rem; color:#333; align-items:start;">
                        <div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <div><strong>Name</strong><div id="confirmOrderName" style="font-size:1.36rem; font-weight:600;">‚Äî</div></div>
                                <div><strong>People</strong><div id="confirmOrderPeople">1</div></div>
                                <div><strong>Background</strong><div id="confirmBackground">N/A</div></div>
                                <div><strong>Prints</strong><div id="confirmOrderPrints">0</div></div>
                                <div><strong>Emails</strong><div id="confirmOrderEmails">N/A</div></div>
                                <div><strong>Payment</strong><div id="confirmOrderPayment">N/A</div></div>
                                <div><strong>Total</strong><div>$<span id="confirmTotal" style="font-size:1.28rem; font-weight:700;">0.00</span></div></div>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px; align-items:center;">
                            <div style="font-weight:600; margin-bottom:6px;">Preview</div>
                            <div id="confirmPreview" style="width:240px; height:180px; border-radius:8px; overflow:hidden; background:#f0f0f0; display:flex; align-items:center; justify-content:center; color:#666;">No photo</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
                        <button class="nav-button" onclick="showScreen('payment')" style="background:#ccc;color:#222;">Cancel</button>
                        <button class="nav-button" onclick="doPrintTicket()" style="background:#667eea;color:#fff;">Confirm & Print</button>
                    </div>
                </div>
            </div>
            <div class="navigation" style="margin-top:18px;">
                <button class="nav-button" onclick="showScreen('payment')">‚Üê Back</button>
                <button class="nav-button" onclick="confirmAndPopupPrint()" style="background:#667eea;color:#fff;">Confirm & Continue</button>
            </div>
        </div>
    </div>
    <div class="kiosk-container">

     <div id="totalBox">
        <strong>üõí Total:</strong> $<span id="totalAmount">0.00</span>
     </div>

        <!-- Welcome Screen -->
        <div class="screen active" id="welcome">
            <div class="header">
                <h1>üì∏ Photo Fun!</h1>
                <h2>Create Amazing Memories</h2>
            </div>
            <div class="content">
                <button class="touch-button" onclick="startSession()" style="max-width: 400px;">
                    <div class="emoji">üéâ</div>
                    <div>Start Photo Session</div>
                </button>
            </div>
        </div>

        <!-- Background Selection -->
        <div class="screen" id="background">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>Choose Your Greenscreen Background</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 14%"></div>
                </div>
            </div>
            <div class="content">
                <div class="background-preview" id="preview"></div>
                <div class="category-tabs" id="categoryTabs">
                    <!-- Category tabs will be populated here -->
                </div>
                <div class="background-options-container">
                    <div class="button-grid grid-3" id="backgroundOptions">
                    <!-- Backgrounds will be populated here -->
                    </div>
                </div>
                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="nextBtn" disabled>Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- People Count -->
        <div class="screen" id="people">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>How Many People will be in the Photo?</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 28%"></div>
                </div>
            </div>
            <div class="content">
                <div class="counter">
                    <button class="counter-button" onclick="changePeople(-1)">‚àí</button>
                    <div class="counter-display" id="peopleCount">1</div>
                    <button class="counter-button" onclick="changePeople(1)">+</button>
                </div>

                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Delivery Method -->
        <div class="screen" id="delivery">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>How Do You Want Your Photos Delivered?</h2>
                <p style="font-size: 1.2rem; margin: 10px 0; color: rgba(255,255,255,0.9);">You can select one or both options and each method of delivery has a cost of $5</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 42%"></div>
                </div>
            </div>
            <div class="content">
                <div class="button-grid grid-2">
                    <button class="touch-button" onclick="toggleDelivery('email')" id="emailBtn">
                        <div class="emoji">üìß</div>
                        <div>Email Me</div>
                    </button>
                    <button class="touch-button" onclick="toggleDelivery('print')" id="printBtn">
                        <div class="emoji">üñ®Ô∏è</div>
                        <div>Print Photos</div>
                    </button>
                </div>
                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="deliveryNext" disabled>Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Email Count -->
        <div class="screen" id="emailCount">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>How Many Email Addresses?</h2>
                <p style="font-size: 1.2rem; margin: 10px 0; color: rgba(255,255,255,0.9);">Enter the number of email addresses you want the picture sent to.</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 56%"></div>
                </div>
            </div>
            <div class="content">
                <div class="counter">
                    <button class="counter-button" onclick="changeEmails(-1)">‚àí</button>
                    <div class="counter-display" id="emailCountDisplay">1</div>
                    <button class="counter-button" onclick="changeEmails(1)">+</button>
                </div>

                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Print Count -->
        <div class="screen" id="printCount">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>How Many Picture(s) to Print?</h2>
                <p id="printPriceDisplay" style="font-size: 1.2rem; margin: 10px 0; color: rgba(255,255,255,0.9);"></p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 56%"></div>
                </div>
            </div>
            <div class="content">
                <div class="counter">
                    <button class="counter-button" onclick="changePrints(-1)">‚àí</button>
                    <div class="counter-display" id="printCountDisplay">1</div>
                    <button class="counter-button" onclick="changePrints(1)">+</button>
                </div>
                

                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Name Entry -->
        <div class="screen" id="nameEntry">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>Enter Your Name</h2>
                <!-- Subheader clarifying purpose of the name (printed on receipt) -->
                <p style="font-size:1.05rem; margin:6px 0; color: rgba(255,255,255,0.92);">This name will be printed on your receipt.</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 84%"></div>
                </div>
            </div>
            <div class="content">
                <input type="text" class="email-input needs-virtual-keyboard" id="customerName" placeholder="Your Name" maxlength="50">

                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="nameNext" disabled>Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Email Entry -->
        <div class="screen" id="emailEntry">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>Enter Email Addresses</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 90%"></div>
                </div>
            </div>
            <div class="content">
                <div id="emailInputs">
                    <!-- Email inputs will be generated here -->
                </div>
                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="emailNext" disabled>Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Camera -->
        <div class="screen" id="camera">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>Take A Photo!</h2>
                <p style="font-size: 1.1rem; margin: 10px 0; color: rgba(255,255,255,0.9); font-style: italic;">This photo is only used to match to the final picture, it will not be used for any other purposes</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 95%"></div>
                </div>
            </div>
            <div class="content">
                <div class="camera-preview" id="cameraPreview">
                    <video id="cameraVideo" class="camera-video" autoplay muted playsinline style="display: none;"></video>
                    <canvas id="cameraCanvas" class="camera-canvas"></canvas>
                    <div id="cameraPlaceholder" class="camera-error">
                        <span>üì∏ Camera Preview<br>Smile! üòä</span>
                    </div>
                </div>
                <div class="button-grid grid-2">
                    <button class="touch-button" onclick="takePhoto()">
                        <div class="emoji">üì∏</div>
                        <div>Take Photo</div>
                    </button>
                    <button class="touch-button" onclick="retakePhoto()" id="retakeBtn" style="display: none;">
                        <div class="emoji">üîÑ</div>
                        <div>Retake</div>
                    </button>
                </div>
                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="cameraNext" disabled>Finish ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Payment Method -->
        <div class="screen" id="payment">
            <button class="quit-button" onclick="quitSession()">‚úï Quit</button>
            <div class="header">
                <h2>Payment Method</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 70%"></div>
                </div>
            </div>
            <div class="content">
                <div class="button-grid grid-3">
                    <button class="touch-button" onclick="selectPayment('cash')" id="cashBtn">
                        <div class="emoji">üíµ</div>
                        <div>Cash</div>
                    </button>
                    <button class="touch-button" onclick="selectPayment('card')" id="cardBtn">
                        <div class="emoji">üí≥</div>
                        <div>Credit/Debit</div>
                    </button>
                    <button class="touch-button" onclick="selectPayment('check')" id="checkBtn">
                        <div class="emoji">üìù</div>
                        <div>Check</div>
                    </button>
                </div>
                <div class="navigation">
                    <button class="nav-button" onclick="goBack()">‚Üê Back</button>
                    <button class="nav-button" onclick="nextStep()" id="paymentNext" disabled>Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Receipt -->
        <div class="screen" id="receipt">
            <div class="header">
                <h1>üéâ All Done!</h1>
                <h2>Here's Your Receipt</h2>
            </div>
            <div class="content" style="overflow-y: auto; justify-content: flex-start; padding-top: 0;">
                <div class="receipt">
                    <!-- Customer Copy -->
                    <div class="receipt-section">
                        <h3 style="text-align: center; margin-top: 0;">CUSTOMER COPY - KEEP THIS!</h3>
                        
                        <div class="receipt-instructions" role="note" aria-label="Important receipt instructions">
                            <div class="ri-icon" aria-hidden="true">üìã</div>
                            <div class="ri-content">
                                <div class="ri-title">INSTRUCTIONS</div>
                                <ul class="ri-list">
                                    <li>Bring this receipt to pick up your print(s) at the end of the event.</li>
                                    <li>Photos are emailed within 24‚Äì48 hours. If you do not receive them, please contact support.</li>
                                </ul>
                            </div>
                        </div>
                        
                        <p><strong>Event:</strong> <span id="receiptEvent">Festival 2025</span></p>
                        <p><strong>Customer:</strong> <span id="receiptName"></span></p>
                        <p><strong>Customer #:</strong> <span id="receiptNumber"></span></p>
                        <p><strong>Date:</strong> <span id="receiptDate"></span></p>
                        <p><strong>Time:</strong> <span id="receiptTime"></span></p>
                        <p><strong>Prints:</strong> <span id="receiptPrints"></span></p>
                        <p><strong>Emails:</strong> <span id="receiptEmails"></span></p>
                        <p><strong>Total Price:</strong> $<span id="receiptPrice"></span></p>
                        <p><strong>Payment:</strong> <span id="receiptPayment"></span></p>
                        
                        <div style="margin: 20px 0;">
                            <strong>Verification:</strong>
                            <div class="stamp-box">PAID</div>
                            <div class="stamp-box">PICKEDUP</div>
                        </div>
                        
                        <div style="font-size: 0.9rem; margin-top: 20px;">
                            <strong>üìß Email Issues?</strong> Contact: gr33nscr33n@photos.com<br>
                            <strong>üìû Questions?</strong> Call: (555)555-5555
                        </div>
                    </div>
                    
                    <!-- Operator Copy -->
                    <div class="receipt-section">
                        <h3 style="text-align: center; margin-top: 0;">OPERATOR COPY</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                            <div><strong>Customer:</strong> <span id="opName"></span></div>
                            <div><strong>Customer #:</strong> <span id="opCustomerId"></span></div>
                            <div><strong>Delivery:</strong> <span id="opDelivery"></span></div>
                            <div><strong>Date:</strong> <span id="opDate"></span></div>
                            <div><strong>Time:</strong> <span id="opTime"></span></div>
                            <div><strong>People:</strong> <span id="opPeople"></span></div>
                            <div><strong>Background:</strong> <span id="opBackground"></span></div>
                            <div><strong>Prints:</strong> <span id="opPrints"></span></div>
                            <div><strong>Emails:</strong> <span id="opEmailCount"></span></div>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <strong>Email Addresses:</strong><br>
                            <div id="opEmailList" style="font-size: 0.8rem;"></div>
                        </div>
                        
                        <div class="large-number" id="photoNumber">001</div>
                        
                        <div style="margin: 15px 0;">
                            <strong>Notes:</strong><br>
                            <div style="border: 1px solid #ccc; height: 40px; margin-top: 5px;"></div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 20px;">
                            <div class="stamp-box">PAID</div>
                            <div class="stamp-box">EMAILED</div>
                            <div class="stamp-box">PRINTED</div>
                            <div class="stamp-box">PICKEDUP</div>
                            <div class="stamp-box">TAKEN PHOTO</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #e8f5e8; padding: 20px; border-radius: 15px; margin: 20px 0; text-align: center; border-left: 5px solid #4caf50;">
                    <h3 style="color: #2e7d32; margin: 0 0 10px 0; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        üñ®Ô∏è Your Receipt Is Printing
                    </h3>
                    <p style="margin: 0; font-size: 1.2rem; color: #333;">Your receipt is being printed now. Please collect it and hand it to the photographer.</p>
                </div>
                
                <div style="margin-top: 30px; display:flex; justify-content:center;">
                    <div style="display:flex; gap:12px;">
                        <button class="touch-button" onclick="startOver()" style="max-width: 200px;">
                            <div class="emoji">üîÑ</div>
                            <div>New Customer</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Password modal handling
        function showPasswordModal() {
            const modal = document.getElementById('passwordModal');
            if (!modal) return;
            // clear previous state
            document.getElementById('pwdInput').value = '';
            document.getElementById('pwdError').textContent = '';
            modal.style.display = 'flex';
            setTimeout(() => document.getElementById('pwdInput').focus(), 80);
        }

        function closePasswordModal() {
            const modal = document.getElementById('passwordModal');
            if (!modal) return;
            modal.style.display = 'none';
        }

        function verifyPasswordAndOpenConfig() {
            const val = document.getElementById('pwdInput').value || '';
            if (val === '1234') {
                closePasswordModal();
                showConfigModal();
            } else {
                const err = document.getElementById('pwdError');
                err.textContent = 'Incorrect PIN. If you stumbled here, press X to exit and continue.';
                // small visual feedback
                const box = document.getElementById('passwordBox');
                if (box) {
                    box.animate([{ transform: 'translateX(-6px)' }, { transform: 'translateX(6px)' }, { transform: 'translateX(0)' }], { duration: 220 });
                }
            }
        }
        // Close modals with Escape
        document.addEventListener('keydown', function (ev) {
            if (ev.key === 'Escape' || ev.key === 'Esc') {
                const pwd = document.getElementById('passwordModal');
                if (pwd && pwd.style.display === 'flex') {
                    closePasswordModal();
                    return;
                }
                const cfg = document.getElementById('configModal');
                if (cfg && cfg.style.display === 'flex') {
                    closeConfigModal();
                    return;
                }
                const timeout = document.getElementById('timeoutModal');
                if (timeout && timeout.style.display === 'flex') {
                    timeout.style.display = 'none';
                }
            }
        });
    </script>
        <!-- Virtual on-screen keyboard (appears for inputs with class 'needs-virtual-keyboard') -->
        <style>
            /* Virtual keyboard: iOS / Apple-like visual style */
            .virtual-keyboard {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 17000;
                background: linear-gradient(#f8f8f8, #ffffff);
                color: #000;
                padding: 12px 10px 18px;
                box-shadow: 0 -12px 30px rgba(0,0,0,0.08);
                border-top-left-radius: 18px;
                border-top-right-radius: 18px;
                -webkit-font-smoothing: antialiased;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            }
            .vk-row { display:flex; gap:12px; justify-content:center; margin-bottom:12px; }
            .vk-key {
                background: linear-gradient(#ffffff, #f5f6f8);
                border: 1px solid rgba(0,0,0,0.06);
                color: #000;
                padding: 16px 14px;
                min-width: 60px;
                border-radius: 12px;
                font-size: 20px;
                line-height: 1;
                text-align: center;
                user-select: none;
                touch-action: manipulation;
                box-shadow: 0 3px 0 rgba(0,0,0,0.04), inset 0 -1px 0 rgba(0,0,0,0.02);
                transition: transform 80ms ease, background 80ms ease, box-shadow 80ms ease;
            }
            .vk-key.wide { min-width: 140px; border-radius: 14px; }
            .vk-key.space { min-width: 420px; border-radius: 14px; }
            .vk-key.active {
                background: linear-gradient(#e9f2ff, #d9eaff);
                border-color: rgba(34,122,255,0.35);
                box-shadow: 0 1px 0 rgba(0,0,0,0.02), inset 0 -1px 0 rgba(255,255,255,0.6);
            }
            .vk-key:active { transform: translateY(1px) scale(0.998); box-shadow:none; }
            .vk-key[aria-pressed='true'] { background: #e6f0ff; }
            .vk-hidden { display: none !important; }
            /* slightly larger spacing for the bottom row to emulate iOS keyboard gutters */
            #vk-row-4 { padding-bottom: 6px; }
        </style>
        <div id="virtualKeyboard" class="virtual-keyboard" style="display:none;" aria-hidden="true" role="application" aria-label="On screen keyboard">
            <div class="vk-row" id="vk-row-1"></div>
            <div class="vk-row" id="vk-row-2"></div>
            <div class="vk-row" id="vk-row-3"></div>
            <div class="vk-row" id="vk-row-4"></div>
            <div class="vk-row" id="vk-row-5"></div>
        </div>
        <script>
            (function(){
                // QWERTY-like layout (rows arranged like a traditional keyboard)
                const layout = {
                    row1: ['1','2','3','4','5','6','7','8','9','0','-','='],
                    row2: ['q','w','e','r','t','y','u','i','o','p'],
                    row3: ['a','s','d','f','g','h','j','k','l',';','\''],
                    row4: ['z','x','c','v','b','n','m',',','.','/']
                };
                const vk = document.getElementById('virtualKeyboard');
                let vkTarget = null;
                let vkShift = false;

                function build() {
                    const r1 = document.getElementById('vk-row-1');
                    const r2 = document.getElementById('vk-row-2');
                    const r3 = document.getElementById('vk-row-3');
                    const r4 = document.getElementById('vk-row-4');
                    const r5 = document.getElementById('vk-row-5');
                    r1.innerHTML = '';
                    r2.innerHTML = '';
                    r3.innerHTML = '';
                    r4.innerHTML = '';
                    r5.innerHTML = '';

                    // Row 1: numbers and top symbols
                    layout.row1.forEach(k => r1.appendChild(makeKey(k)));

                    // Row 2: Q W E R T Y U I O P (Backspace placed to the right of 'p')
                    layout.row2.forEach(k => r2.appendChild(makeKey(k)));
                    const bksp = makeKey('‚å´', 'wide'); bksp.addEventListener('click', onBackspace); r2.appendChild(bksp);

                    // Row 3: A-L and punctuation, Enter on the right
                    layout.row3.forEach(k => r3.appendChild(makeKey(k)));
                    const enter = makeKey('Enter', 'wide'); enter.addEventListener('click', onEnter); r3.appendChild(enter);

                    // Row 4: Shift (left), Z-M and punctuation (single left Shift only)
                    const shiftLeftRow = makeKey('Shift', 'wide'); shiftLeftRow.addEventListener('click', onShift); r4.appendChild(shiftLeftRow);
                    layout.row4.forEach(k => r4.appendChild(makeKey(k)));

                    // Row 5: Space and Hide (bottom row)
                    const space = makeKey('Space', 'space'); space.addEventListener('click', onSpace); r5.appendChild(space);
                    const at = makeKey('@'); r5.appendChild(at);
                    // quick domain completion key for email entry
                    const dotCom = makeKey('.com'); r5.appendChild(dotCom);
                    const hide = makeKey('Hide', 'wide'); hide.addEventListener('click', hideVirtualKeyboard); r5.appendChild(hide);
                }

                function makeKey(label, extra) {
                    const d = document.createElement('button');
                    d.type = 'button';
                    d.className = 'vk-key' + (extra ? ' ' + extra : '');
                    d.textContent = label;
                    d.setAttribute('aria-label', label);
                    d.addEventListener('click', () => onKey(label));
                    return d;
                }

                function onKey(label) {
                    if (!vkTarget) return;
                    if (label === 'Shift' || label === 'Tab' || label === 'Enter' || label === 'Space' || label === 'Hide' || label === '‚å´') return;
                    let ch = label;
                    if (vkShift) ch = ch.toUpperCase();
                    // Insert using caret-preserving helper which will honor any previously-captured caret
                    insertTextAtCursor(vkTarget, ch);
                    // if shift was single-use, turn off
                    if (vkShift) { vkShift = false; refreshShiftState(); }
                    // keep focus but avoid an extra focus() call here which can move caret on some platforms
                }

                function onBackspace() {
                    if (!vkTarget) return;
                    const el = vkTarget;
                    try {
                        // honor any previously-captured caret position
                        if (window._vkDesiredCaret && window._vkDesiredCaret.el === el && typeof window._vkDesiredCaret.start === 'number') {
                            try { el.setSelectionRange(window._vkDesiredCaret.start, window._vkDesiredCaret.end ?? window._vkDesiredCaret.start); } catch (e) {}
                            window._vkDesiredCaret = null;
                        }

                        if (typeof el.selectionStart === 'number') {
                            let start = el.selectionStart;
                            let end = el.selectionEnd;
                            if (start === end && start > 0) {
                                el.value = el.value.slice(0, start - 1) + el.value.slice(end);
                                el.selectionStart = el.selectionEnd = start - 1;
                            } else if (start !== end) {
                                el.value = el.value.slice(0, start) + el.value.slice(end);
                                el.selectionStart = el.selectionEnd = start;
                            }
                        } else {
                            el.value = el.value.slice(0, -1);
                        }
                    } catch (e) {
                        // fallback: pop last char
                        el.value = el.value.slice(0, -1);
                    }
                    // keep focus and emit input
                    try { el.focus(); } catch (e) {}
                    el.dispatchEvent(new Event('input', { bubbles: true }));
                }

                function onSpace() { if (vkTarget) { insertTextAtCursor(vkTarget, ' '); vkTarget.focus(); vkTarget.dispatchEvent(new Event('input',{bubbles:true})); } }
                function onEnter() {
                    if (!vkTarget) return;
                    // If we're on the password field, try submit
                    if (vkTarget.id === 'pwdInput') {
                        verifyPasswordAndOpenConfig();
                    } else {
                        focusNextInput(vkTarget);
                    }
                }
                function onTab() { focusNextInput(vkTarget); }

                function onShift() { vkShift = !vkShift; refreshShiftState(); }
                function refreshShiftState() {
                    document.querySelectorAll('.vk-key').forEach(k => {
                        // update letter case
                        if (k.textContent.length === 1 && /[a-zA-Z]/.test(k.textContent)) {
                            k.textContent = vkShift ? k.textContent.toUpperCase() : k.textContent.toLowerCase();
                        }
                        // mark shift keys with aria-pressed
                        if (k.textContent === 'Shift') {
                            k.setAttribute('aria-pressed', String(!!vkShift));
                        }
                    });
                    document.querySelectorAll('.vk-key').forEach(k => k.classList.remove('active'));
                    if (vkShift) {
                        document.querySelectorAll('.vk-key').forEach(k => { if (k.textContent.length === 1 && /[A-Z]/.test(k.textContent)) k.classList.add('active'); });
                    }
                }

                function focusNextInput(current) {
                    const list = Array.from(document.querySelectorAll('.needs-virtual-keyboard'));
                    const idx = list.indexOf(current);
                    if (idx >= 0 && idx < list.length - 1) {
                        list[idx + 1].focus();
                    } else {
                        // otherwise hide
                        hideVirtualKeyboard();
                    }
                }

                function insertTextAtCursor(el, text) {
                    try {
                        // Ensure target has focus, but don't rely on focus() alone to set caret correctly on some browsers
                        try { el.focus({ preventScroll: true }); } catch (e) { try { el.focus(); } catch (e) {} }

                        // If we previously captured a desired caret for this element (from pointerup), honor it now
                        if (window._vkDesiredCaret && window._vkDesiredCaret.el === el && typeof window._vkDesiredCaret.start === 'number') {
                            try {
                                el.setSelectionRange(window._vkDesiredCaret.start, window._vkDesiredCaret.end ?? window._vkDesiredCaret.start);
                            } catch (e) { /* ignore if unsupported */ }
                            // clear saved caret now that we're using it
                            window._vkDesiredCaret = null;
                        }

                        if (typeof el.selectionStart === 'number') {
                            const start = el.selectionStart;
                            const end = el.selectionEnd;
                            el.value = el.value.slice(0, start) + text + el.value.slice(end);
                            const newPos = start + text.length;
                            try { el.setSelectionRange(newPos, newPos); } catch (e) { el.selectionStart = el.selectionEnd = newPos; }
                        } else {
                            el.value += text;
                        }
                        el.dispatchEvent(new Event('input', { bubbles: true }));
                    } catch (e) { console.warn('VK insert failed', e); }
                }

                // Estimate caret index inside a single-line input from a clientX coordinate.
                // Uses canvas.measureText with the input's computed font to approximate character widths.
                function estimateCaretIndexFromClientX(inputEl, clientX) {
                    try {
                        if (!inputEl || typeof clientX !== 'number') return 0;
                        const rect = inputEl.getBoundingClientRect();
                        const style = window.getComputedStyle(inputEl);
                        const font = style.font || [style.fontStyle, style.fontVariant, style.fontWeight, style.fontSize, style.fontFamily].filter(Boolean).join(' ');
                        // Compute left padding and border to find content start
                        const paddingLeft = parseFloat(style.paddingLeft || 0) || 0;
                        const borderLeft = parseFloat(style.borderLeftWidth || 0) || 0;
                        const contentLeft = rect.left + paddingLeft + borderLeft;
                        let relativeX = clientX - contentLeft;
                        if (relativeX < 0) relativeX = 0;
                        // Use canvas to measure text width
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        ctx.font = font || '16px Arial';
                        const val = inputEl.value || '';
                        // Walk characters and measure cumulative width until we exceed relativeX
                        let cum = 0;
                        for (let i = 0; i <= val.length; i++) {
                            const slice = val.slice(0, i);
                            const metrics = ctx.measureText(slice);
                            const w = metrics.width;
                            if (w >= relativeX) return i;
                            cum = w;
                        }
                        return val.length;
                    } catch (e) { return 0; }
                }

                function showVirtualKeyboard(target) {
                    vkTarget = target || document.activeElement;
                    if (!vkTarget) return;
                    vk.style.display = 'block';
                    vk.setAttribute('aria-hidden','false');
                    // small delay to ensure mobile-like behavior
                    setTimeout(() => { try {
                            // Only focus if the target isn't already the active element ‚Äî
                            // refocusing can move the caret to the end and prevent placing the cursor where the user tapped.
                            if (document.activeElement !== vkTarget) vkTarget.focus();
                        } catch (e) {} }, 10);
                    // after keyboard is visible, move bottom controls up to remain above it
                    setTimeout(() => {
                        try { moveBottomControls(true); } catch (e) { /* ignore */ }
                    }, 80);
                    // If the user tapped inside the target input recently, restore caret (with coordinate fallback)
                    setTimeout(() => {
                        try {
                            if (!window._vkDesiredCaret || window._vkDesiredCaret.el !== vkTarget) return;
                            // If we have numeric indices use them
                            if (typeof window._vkDesiredCaret.start === 'number') {
                                try { vkTarget.setSelectionRange(window._vkDesiredCaret.start, window._vkDesiredCaret.end ?? window._vkDesiredCaret.start); } catch (e) { /* ignore */ }
                                window._vkDesiredCaret = null;
                                return;
                            }
                            // Fallback: if we captured pointer coordinates, estimate a caret index from the X coordinate
                            if (typeof window._vkDesiredCaret.coordX === 'number') {
                                try {
                                    const idx = estimateCaretIndexFromClientX(vkTarget, window._vkDesiredCaret.coordX);
                                    if (typeof idx === 'number') {
                                        try { vkTarget.setSelectionRange(idx, idx); } catch (e) { /* ignore */ }
                                    }
                                } catch (e) { /* ignore */ }
                                window._vkDesiredCaret = null;
                                return;
                            }
                        } catch (e) { /* ignore */ }
                    }, 120);
                }

                function hideVirtualKeyboard() {
                    vk.style.display = 'none';
                    vk.setAttribute('aria-hidden','true');
                    vkTarget = null; vkShift = false; refreshShiftState();
                    try { moveBottomControls(false); } catch (e) {}
                }

                // Move bottom controls (navigation, quit button, total box) above the keyboard
                function moveBottomControls(up) {
                    // Only move bottom navigation rows; do not shift top-of-screen controls like quit or totalBox
                    const selectors = ['.navigation', '.move-with-vk'];
                    const els = selectors.map(s => Array.from(document.querySelectorAll(s))).flat();
                    if (!els || !els.length) return;
                    if (up) {
                        // Use actual rendered height of VK
                        const rect = vk.getBoundingClientRect();
                        const h = Math.round(rect.height || 360);
                        els.forEach(el => {
                            // Ensure a smooth transition
                            el.style.transition = el.style.transition || 'transform 0.25s ease';
                            // Move up by keyboard height so they remain visible (negative Y)
                            el.style.transform = `translateY(-${h}px)`;
                        });
                    } else {
                        els.forEach(el => {
                            el.style.transform = '';
                        });
                    }
                }

                // Track pointer downs so blurs caused by interacting with the keyboard don't auto-close it
                let lastPointerDownInsideVK = false;
                document.addEventListener('pointerdown', (ev) => {
                    try { lastPointerDownInsideVK = !!ev.target.closest && !!ev.target.closest('.virtual-keyboard'); } catch (e) { lastPointerDownInsideVK = false; }
                    // If keyboard is visible and the pointer down is outside both the keyboard and any input-like element, hide it.
                    if (vk.style.display === 'block') {
                        const clickedVK = ev.target.closest && ev.target.closest('.virtual-keyboard');
                        const clickedNeedsVK = ev.target.closest && ev.target.closest('.needs-virtual-keyboard');
                        const clickedEmailArea = ev.target.closest && ev.target.closest('#emailInputs');
                        const tag = ev.target && ev.target.tagName ? ev.target.tagName.toUpperCase() : '';
                        const clickedInputLike = clickedNeedsVK || clickedEmailArea || tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';
                        if (!clickedVK && !clickedInputLike) {
                            hideVirtualKeyboard();
                        }
                    }
                }, true);

                // Remember caret position when user taps (pointerup) into an input using the virtual keyboard
                window._vkDesiredCaret = null;
                document.addEventListener('pointerup', (ev) => {
                    try {
                        const t = ev.target;
                        if (!t) return;
                        // if the target is an input or textarea that uses the VK, record selection
                        const isVKInput = t.matches && (t.matches('input.needs-virtual-keyboard') || t.matches('textarea.needs-virtual-keyboard'));
                        if (isVKInput) {
                            try {
                                const start = (typeof t.selectionStart === 'number') ? t.selectionStart : null;
                                const end = (typeof t.selectionEnd === 'number') ? t.selectionEnd : start;
                                // capture pointer coordinates as a fallback if selection indices are not provided reliably
                                const coordX = (typeof ev.clientX === 'number') ? ev.clientX : null;
                                const coordY = (typeof ev.clientY === 'number') ? ev.clientY : null;
                                if (start !== null) {
                                    window._vkDesiredCaret = { el: t, start: start, end: end };
                                } else if (coordX !== null) {
                                    // store coord fallback; we'll resolve to an index when showing the keyboard
                                    window._vkDesiredCaret = { el: t, coordX: coordX, coordY: coordY };
                                }
                            } catch (e) { window._vkDesiredCaret = null; }
                        }
                    } catch (e) { /* ignore */ }
                }, true);

                // Attach auto-show to focus events for inputs with class
                document.addEventListener('focusin', (ev) => {
                    const t = ev.target;
                    if (!t) return;
                    if (t.classList && t.classList.contains('needs-virtual-keyboard')) {
                        showVirtualKeyboard(t);
                    }
                });

                document.addEventListener('focusout', (ev) => {
                    const t = ev.target;
                    if (!t) return;
                    // hide on blur after a short delay so clicks on VK keys still register
                    setTimeout(() => {
                        // if the last pointerdown was inside the virtual keyboard, don't hide (user interacted with keyboard area)
                        if (lastPointerDownInsideVK) { lastPointerDownInsideVK = false; return; }
                        if (!document.activeElement || !document.activeElement.classList || !document.activeElement.classList.contains('needs-virtual-keyboard')) {
                            // if focus did not move into another needs-virtual-keyboard input, and focus isn't inside the keyboard, hide
                            if (!document.activeElement || !document.activeElement.closest || !document.activeElement.closest('.virtual-keyboard')) hideVirtualKeyboard();
                        }
                    }, 120);
                });

                // Build keyboard on startup
                build();

                // Expose for other code
                window.showVirtualKeyboard = showVirtualKeyboard;
                window.hideVirtualKeyboard = hideVirtualKeyboard;
            })();
            </script>

            <style>
                /* Global typography: normalize and enlarge text for better readability.
                   Uses !important to override inline sizes where necessary in this single-file app. */
                :root{ --base-font: 20px; --h1:32px; --h2:24px; --h3:20px; --body-line:1.45; --ui-font:18px; }
                body, .kiosk-container, .screen, .content, .receipt, .header { font-size: var(--base-font) !important; line-height: var(--body-line) !important; }
                h1 { font-size: var(--h1) !important; }
                h2 { font-size: var(--h2) !important; }
                h3 { font-size: var(--h3) !important; }
                p, label, div, span { font-size: var(--base-font) !important; }
                button, .nav-button, .touch-button { font-size: var(--ui-font) !important; }
                input, textarea, select, .email-input { font-size: var(--ui-font) !important; }
                .vk-key { font-size: 20px !important; padding: 18px 14px !important; }
                /* Emphasize confirmation name/total but keep sizes consistent */
                #confirmOrderName { font-size: 1.6rem !important; font-weight: 600 !important; }
                #confirmTotal { font-size: 1.4rem !important; font-weight: 700 !important; }
                /* Ensure receipt/operator copies remain readable */
                .receipt-section { font-size: 18px !important; }
                /* Receipt instructions ‚Äî prominent but calm styling (darker gray for better contrast) */
                .receipt-instructions {
                    display: flex;
                    gap: 12px;
                    align-items: flex-start;
                    /* stronger neutral gray background so the box is more obvious */
                    background-color: #e6e6e6; /* fallback for older browsers */
                    background: linear-gradient(180deg, #f2f2f2 0%, #dcdcdc 100%);
                    border-left: 6px solid #ffb74d; /* warm accent */
                    padding: 14px 14px 14px 12px;
                    margin: 14px 0;
                    border-radius: 8px;
                    /* slightly stronger shadow for clearer separation */
                    box-shadow: 0 8px 24px rgba(20, 40, 60, 0.09);
                    color: #12202b;
                    line-height: 1.35;
                }
                .receipt-instructions .ri-icon { font-size: 1.6rem; margin-top: 2px; }
                .receipt-instructions .ri-content { flex: 1; }
                .receipt-instructions .ri-title { font-weight: 700; font-size: 1.05rem; margin-bottom: 6px; color: #0f1720; }
                .receipt-instructions .ri-list { margin: 0; padding-left: 18px; font-size: 1rem; }
                .receipt-instructions .ri-list li { margin-bottom: 6px; }
                /* Accessibility: prefer no animation here; dropdown will appear above the button. */
            </style>

        <script>
            // Configuration (would be loaded from external file)
        const config = {
            eventName: "Festival 2025",
            basePrice: 5.00,
            additionalPrintPrice: 1.00,
            paymentMethods: ['cash', 'card', 'check'],
            deliveryMethods: ['email', 'print'],
            maxPrints: 11,
            maxEmails: 5,
            backgroundCategories: {
                "Nature": [
                    { id: 2, name: "Sunset Beach", imageUrl: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="Sunset Beach">` },
                    { id: 3, name: "Forest Magic", imageUrl: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="Forest Magic">` },
                    { id: 4, name: "Mountain View", imageUrl: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="Mountain View">` },
                     { id: 5, name: "Lake Escape", imageUrl: "https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=60&h=40&fit=crop" style="width:60px;height:40px;border-radius:4px;" alt="Lake Escape">` },
                    { id: 7, name: "Desert Road", imageUrl: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=60&h=40&fit=crop" style="width:60px;height:40px;border-radius:4px;" alt="Desert Road">` }
                ],

                "Fun Backgrounds": [

                    { id: 13, name: "Galaxy", imageUrl: "https://images.unsplash.com/photo-1502134249126-9f3755a50d78?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1502134249126-9f3755a50d78?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="Galaxy">` },
                    { id: 14, name: "Rave", imageUrl: "https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="Rave">` }
                ],
                "Other": [
                    { id: 15, name: "City Lights", imageUrl: "https://images.unsplash.com/photo-1514565131-fce0801e5785?w=800&h=600&fit=crop", preview: `<img src="https://images.unsplash.com/photo-1514565131-fce0801e5785?w=60&h=40&fit=crop" style="width: 60px; height: 40px; border-radius: 4px;" onerror="this.style.display='none';" alt="City Lights">` },
                    { id: 18, name: "Custom Background", preview: `<svg width="60" height="40" viewBox="0 0 60 40"><rect width="60" height="40" fill="#f0f0f0" stroke="#ccc" stroke-width="1"/><path d="M30,10 L35,20 L25,20 Z" fill="#666"/><rect x="25" y="20" width="10" height="8" fill="#666"/><text x="30" y="35" text-anchor="middle" fill="#000000" font-size="6">Upload</text></svg>` }
                ]
            }
        };

        // --- Persisted operator config helpers ---
        const STORAGE_KEY = 'kiosk_config_v1';

        function saveConfigToStorage() {
            try {
                const toSave = {
                    eventName: config.eventName,
                    basePrice: config.basePrice,
                    additionalPrintPrice: config.additionalPrintPrice,
                    paymentMethods: config.paymentMethods,
                    deliveryMethods: config.deliveryMethods,
                    maxPrints: config.maxPrints,
                    maxEmails: config.maxEmails,
                    enabledBackgrounds: window.enabledBackgrounds || {}
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
            } catch (e) {
                console.warn('Failed to save config', e);
            }
        }

        function loadSavedConfig() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const saved = JSON.parse(raw);
                if (saved.eventName) config.eventName = saved.eventName;
                if (typeof saved.basePrice === 'number') config.basePrice = saved.basePrice;
                if (typeof saved.additionalPrintPrice === 'number') config.additionalPrintPrice = saved.additionalPrintPrice;
                if (Number.isInteger(saved.maxPrints)) config.maxPrints = saved.maxPrints;
                if (Number.isInteger(saved.maxEmails)) config.maxEmails = saved.maxEmails;
                if (Array.isArray(saved.paymentMethods)) config.paymentMethods = saved.paymentMethods;
                if (Array.isArray(saved.deliveryMethods)) config.deliveryMethods = saved.deliveryMethods;
                if (saved.enabledBackgrounds) window.enabledBackgrounds = saved.enabledBackgrounds;
            } catch (e) {
                console.warn('Failed to load saved config', e);
            }
        }

        // --- Secret 5-tap handler to show config modal ---
        (function () {
            let count = 0;
            let timer = null;
            const required = 5;
            const resetMs = 600;

            document.addEventListener('click', function (ev) {
                // ignore clicks on interactive elements
                if (ev.target.closest && ev.target.closest('button, input, textarea, select, .config-modal, .password-modal')) return;
                count++;
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => { count = 0; timer = null; }, resetMs);
                if (count >= required) {
                    count = 0;
                    showPasswordModal();
                }
            }, true);
        })();

        // Populate config modal inputs from current runtime config
        function populateConfigUI() {
            const el = (id) => document.getElementById(id);
            el('cfgEventName').value = config.eventName || '';
            el('cfgBasePrice').value = (typeof config.basePrice === 'number') ? config.basePrice.toFixed(2) : '';
            el('cfgAdditionalPrintPrice').value = (typeof config.additionalPrintPrice === 'number') ? config.additionalPrintPrice.toFixed(2) : '';
            el('cfgMaxPrints').value = config.maxPrints || 0;
            el('cfgMaxEmails').value = config.maxEmails || 0;

            el('cfgPay_cash').checked = config.paymentMethods.includes('cash');
            el('cfgPay_card').checked = config.paymentMethods.includes('card');
            el('cfgPay_check').checked = config.paymentMethods.includes('check');

            el('cfgDel_email').checked = config.deliveryMethods.includes('email');
            el('cfgDel_print').checked = config.deliveryMethods.includes('print');

            buildCfgBackgroundList();
            // populate demo ticket history
            try { buildTicketHistory(); } catch (e) { /* ignore in case not present */ }
        }

        function buildCfgBackgroundList() {
            const container = document.getElementById('cfgBackgroundList');
            container.innerHTML = '';
            window.enabledBackgrounds = window.enabledBackgrounds || {};
                    // If there are any uploaded temp images, show an "Uploaded Images" header
                    if (window.tempUploads && window.tempUploads.length) {
                        const upHeader = document.createElement('div'); upHeader.innerHTML = `<strong>Uploaded Images (demo)</strong>`; upHeader.style.marginTop = '6px';
                        container.appendChild(upHeader);
                        window.tempUploads.forEach(u => {
                            const row = document.createElement('div');
                            row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.gap = '8px'; row.style.margin = '6px 0';
                            const preview = document.createElement('div'); preview.innerHTML = `<img src="${u.dataUrl}" style="width:60px;height:40px;border-radius:4px;" />`;
                            const label = document.createElement('div'); label.textContent = u.name;
                            const btn = document.createElement('button'); btn.className = 'nav-button'; btn.textContent = 'Add to backgrounds'; btn.style.padding='6px 10px'; btn.style.background='#4CAF50'; btn.style.color='#fff';
                            btn.addEventListener('click', () => addUploadToBackground(u.id));
                            row.appendChild(preview); row.appendChild(label); row.appendChild(btn);
                            container.appendChild(row);
                        });
                    }

                    Object.keys(config.backgroundCategories).forEach(cat => {
                const h = document.createElement('div'); h.innerHTML = `<strong>${cat}</strong>`; h.style.marginTop = '8px';
                container.appendChild(h);
                config.backgroundCategories[cat].forEach(bg => {
                    const id = String(bg.id);
                    const row = document.createElement('label');
                    row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.gap = '8px'; row.style.margin = '6px 0';
                    const cb = document.createElement('input'); cb.type = 'checkbox'; cb.dataset.bgId = id;
                    cb.checked = (window.enabledBackgrounds[id] === undefined) ? true : !!window.enabledBackgrounds[id];
                    cb.addEventListener('change', () => { window.enabledBackgrounds[id] = cb.checked; });
                    const preview = document.createElement('div'); preview.innerHTML = bg.preview || ''; preview.style.width='60px'; preview.style.height='40px';
                    const label = document.createElement('div'); label.textContent = bg.name;
                    row.appendChild(cb); row.appendChild(preview); row.appendChild(label);
                    container.appendChild(row);
                });
            });
        }

        function showConfigModal() {
            const modal = document.getElementById('configModal');
            if (!modal) return;
            populateConfigUI();
            modal.style.display = 'flex';
            // focus first input
            setTimeout(() => document.getElementById('cfgEventName').focus(), 60);
        }

        function closeConfigModal() {
            const modal = document.getElementById('configModal');
            if (!modal) return;
            modal.style.display = 'none';
        }

        function applyConfig() {
            const el = (id) => document.getElementById(id);
            const evn = el('cfgEventName').value || config.eventName;
            const bp = parseFloat(el('cfgBasePrice').value) || 0;
            const ap = parseFloat(el('cfgAdditionalPrintPrice').value) || 0;
            const mp = parseInt(el('cfgMaxPrints').value) || config.maxPrints;
            const me = parseInt(el('cfgMaxEmails').value) || config.maxEmails;

            const pays = [];
            if (el('cfgPay_cash').checked) pays.push('cash');
            if (el('cfgPay_card').checked) pays.push('card');
            if (el('cfgPay_check').checked) pays.push('check');

            const dels = [];
            if (el('cfgDel_email').checked) dels.push('email');
            if (el('cfgDel_print').checked) dels.push('print');

            config.eventName = evn;
            config.basePrice = bp;
            config.additionalPrintPrice = ap;
            config.maxPrints = mp;
            config.maxEmails = me;
            if (pays.length) config.paymentMethods = pays;
            if (dels.length) config.deliveryMethods = dels;

            window.enabledBackgrounds = window.enabledBackgrounds || {};
            saveConfigToStorage();

            // refresh dependent UI
            if (typeof updateMethodButtons === 'function') updateMethodButtons();
            loadBackgrounds();
            try { updatePrintPriceDisplay(); } catch (e) { /* ignore if not present */ }
            try { updateTotalBox(); } catch (e) { /* ignore */ }

            closeConfigModal();
        }

        // Demo reprint flow (does not actually print)
        let _reprintPending = null;
        function showReprintModal(ticketId) {
            _reprintPending = ticketId;
            const txt = document.getElementById('reprintText');
            if (txt) txt.textContent = `Reprint ticket ${ticketId}? This is a demo action.`;
            const modal = document.getElementById('reprintModal');
            if (modal) modal.style.display = 'flex';
        }

        function confirmReprint() {
            const modal = document.getElementById('reprintModal');
            if (modal) modal.style.display = 'none';
            if (_reprintPending) {
                // Demo feedback: small transient notice
                const note = document.createElement('div');
                note.style.cssText = 'position:fixed; bottom:20px; right:20px; background:#222; color:#fff; padding:12px 16px; border-radius:8px; z-index:20000; box-shadow:0 8px 20px rgba(0,0,0,0.3);';
                note.textContent = `Reprint queued for ${_reprintPending}`;
                document.body.appendChild(note);
                setTimeout(() => note.remove(), 2500);
                _reprintPending = null;
            }
        }

        // Hide disabled backgrounds in chooser
        const _origLoadBackgroundsForCategory = typeof loadBackgroundsForCategory === 'function' ? loadBackgroundsForCategory : null;
        function loadBackgroundsForCategory(category) {
            // If original exists earlier, keep its behavior but enforce enabledBackgrounds
            const container = document.getElementById('backgroundOptions');
            container.innerHTML = '';
            const backgrounds = config.backgroundCategories[category] || [];
            const enabled = window.enabledBackgrounds || {};
            backgrounds.forEach(bg => {
                if (enabled[String(bg.id)] === false) return;
                const button = document.createElement('button');
                button.className = 'touch-button';
                button.onclick = (e) => selectBackground(bg, e);
                button.innerHTML = `
                    <div style="width: 60px; height: 40px; border-radius: 8px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;">${bg.preview}</div>
                    <div>${bg.name}</div>`;
                container.appendChild(button);
            });
        }

        // Update visible payment/delivery buttons
        function updateMethodButtons() {
            const emailBtn = document.getElementById('emailBtn');
            const printBtn = document.getElementById('printBtn');
            if (emailBtn) emailBtn.style.display = config.deliveryMethods.includes('email') ? 'flex' : 'none';
            if (printBtn) printBtn.style.display = config.deliveryMethods.includes('print') ? 'flex' : 'none';

            const cashBtn = document.getElementById('cashBtn');
            const cardBtn = document.getElementById('cardBtn');
            const checkBtn = document.getElementById('checkBtn');
            if (cashBtn) cashBtn.style.display = config.paymentMethods.includes('cash') ? 'flex' : 'none';
            if (cardBtn) cardBtn.style.display = config.paymentMethods.includes('card') ? 'flex' : 'none';
            if (checkBtn) checkBtn.style.display = config.paymentMethods.includes('check') ? 'flex' : 'none';
        }

        // initialize persisted config
        loadSavedConfig();
        window.enabledBackgrounds = window.enabledBackgrounds || {};
        if (typeof updateMethodButtons === 'function') updateMethodButtons();
        try { updatePrintPriceDisplay(); } catch (e) { /* ignore if not present yet */ }

    // Demo ticket history (simple signifiers for operator reprint demo)
    const ticketHistory = [
        { id: 'TCK-001', name: 'Alice M.', date: '2025-10-20 14:32', items: 'Print x2, Email x1' },
        { id: 'TCK-002', name: 'Bob J.', date: '2025-10-21 11:05', items: 'Email x1' },
        { id: 'TCK-003', name: 'Carol K.', date: '2025-10-22 16:48', items: 'Print x1' }
    ];

    function buildTicketHistory() {
        const container = document.getElementById('cfgTicketHistory');
        if (!container) return;
        container.innerHTML = '';
        ticketHistory.forEach(t => {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = 'space-between';
            row.style.alignItems = 'center';
            row.style.padding = '8px';
            row.style.borderBottom = '1px solid #eee';
            row.innerHTML = `
                <div style="display:flex;flex-direction:column; gap:2px;">
                    <strong style="font-size:0.95rem;">${t.id} ‚Äî ${t.name}</strong>
                    <span style="font-size:0.85rem; color:#666;">${t.date} ¬∑ ${t.items}</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="nav-button" style="padding:8px 12px; border-radius:8px; background:#4CAF50; border:none; color:#fff;" onclick="showReprintModal('${t.id}')">Reprint</button>
                </div>
            `;
            container.appendChild(row);
        });
    }

        // Demo upload handling (in-memory only)
        window.tempUploads = window.tempUploads || [];

        function handleUploadFile(file) {
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                const item = { id: 'UP-' + Date.now(), name: file.name, dataUrl };
                window.tempUploads.push(item);
                buildTempUploadsUI();
                buildCfgBackgroundList();
            };
            reader.readAsDataURL(file);
        }

        function buildTempUploadsUI() {
            const list = document.getElementById('cfgUploadList');
            if (!list) return;
            list.innerHTML = '';
            window.tempUploads.forEach(u => {
                const el = document.createElement('div');
                el.style.display = 'flex'; el.style.flexDirection = 'column'; el.style.alignItems = 'center'; el.style.gap = '6px'; el.style.width = '80px';
                el.innerHTML = `
                    <img src="${u.dataUrl}" alt="${u.name}" style="width:72px; height:72px; object-fit:cover; border-radius:6px; border:1px solid #ddd;" />
                    <button class="nav-button" style="padding:6px 8px; font-size:0.85rem;" onclick="addUploadToBackground('${u.id}')">Add</button>
                `;
                list.appendChild(el);
            });
        }

        function addUploadToBackground(uploadId) {
            const up = window.tempUploads.find(x => x.id === uploadId);
            if (!up) return;
            // add uploaded image into the existing 'Other' category so it appears in the chooser
            const targetCat = 'Other';
            config.backgroundCategories[targetCat] = config.backgroundCategories[targetCat] || [];
            const newId = -Date.now();
            const bg = { id: newId, name: up.name || 'Uploaded', imageUrl: up.dataUrl, preview: `<img src="${up.dataUrl}" style="width:60px;height:40px;border-radius:4px;">` };
            config.backgroundCategories[targetCat].push(bg);
            buildCfgBackgroundList();
        }

        // wire upload input/button
        setTimeout(() => {
            const inp = document.getElementById('cfgUploadInput');
            const btn = document.getElementById('cfgUploadBtn');
            if (inp) inp.addEventListener('change', (ev) => handleUploadFile(ev.target.files[0]));
            if (btn && inp) btn.addEventListener('click', () => { if (inp.files && inp.files[0]) handleUploadFile(inp.files[0]); else inp.click(); });
        }, 120);

        // Session data
        let session = {
            background: null,
            people: 1,
            delivery: [], // supports multiple delivery methods
            emailCount: 1,
            printCount: 1,
            payment: null,
            name: '',
            emails: [],
            customerNumber: null,
            photoTaken: false,
            photoData: null
        };

        let currentScreen = 'welcome';
        let photoCounter = 1;
        let currentCategory = 'Nature';

        // Price calculation
        function calculatePrice() {
            let total = 0;

	   if (session.delivery.includes('email')) {
	       total += config.basePrice;
	   }
            
	   if (session.delivery.includes('print')) {
                total += config.basePrice;
                if (session.printCount > 1) {
                    total += (session.printCount - 1) * config.additionalPrintPrice;
                }
            }
            return total;
        }

        // Screen navigation
        function showScreen(screenId) {
            try {
                // hide all screens explicitly (clear any inline display styles)
                document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.style.display = 'none'; });
                const el = document.getElementById(screenId);
                if (!el) {
                    console.warn('showScreen: target not found', screenId);
                    const fallback = document.getElementById('welcome');
                    if (fallback) { fallback.classList.add('active'); fallback.style.display = 'flex'; currentScreen = 'welcome'; }
                    return;
                }
                // mark active and ensure it's visible
                el.classList.add('active');
                el.style.display = 'flex';
                currentScreen = screenId;
                // Ensure the accessibility panel is positioned correctly when screens change
                try {
                    const panel = document.getElementById('a11yPanel');
                    // if the panel is open, keep it aligned above the button (no animation)
                    if (panel && panel.style.display === 'block') {
                        panel.style.left = '0px';
                        panel.style.bottom = 'calc(100% + 8px)';
                    }
                } catch (e) { /* ignore */ }
            } catch (e) {
                console.error('showScreen error', e);
                return;
            }
            
            const totalBox = document.getElementById('totalBox');
            const visibleScreens = ['background','people','delivery','emailCount','printCount','payment','nameEntry','emailEntry','camera','confirmOrder'];
            if (visibleScreens.includes(screenId)) {
                totalBox.style.display = 'block';
            } else {
                totalBox.style.display = 'none';
            }
            
            
            // Instructions screen removed ‚Äî no setup needed here
        }
        
        
        // Camera functions
        let cameraStream = null;
        
        async function initializeCamera() {
            const video = document.getElementById('cameraVideo');
            const placeholder = document.getElementById('cameraPlaceholder');
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    } 
                });
                
                video.srcObject = cameraStream;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                
            } catch (error) {
                console.error('Camera access denied or not available:', error);
                placeholder.innerHTML = '<span>üì∏ Camera not available<br>Please allow camera access</span>';
                placeholder.style.background = '#ffe6e6';
                placeholder.style.display = 'flex';
            }
        }
        
        function stopCamera() {
            const video = document.getElementById('cameraVideo');
            const placeholder = document.getElementById('cameraPlaceholder');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.style.display = 'none';
            video.srcObject = null;
            
            if (placeholder) {
                placeholder.style.display = 'flex';
                placeholder.innerHTML = '<span>üì∏ Camera Preview<br>Smile! üòä</span>';
                placeholder.style.background = '#f0f0f0';
            }
        }

        function startSession() {
            // Reset all session data for new customer
            session = {
                background: null,
                people: 1,
                delivery: [],
                emailCount: 1,
                printCount: 1,
                payment: null,
                name: '',
                emails: [],
                customerNumber: 'CN' + Date.now().toString().slice(-6),
                photoTaken: false,
                photoData: null
            };
            
            resetAllUI();
            loadBackgrounds();
            showScreen('background');

            // Ensure camera is ready for this customer
            initializeCamera();
        }

        function goBack() {
            const screens = ['welcome', 'background', 'people', 'delivery', 'emailCount', 'printCount', 'emailEntry', 'nameEntry', 'camera', 'payment', 'receipt'];
            const currentIndex = screens.indexOf(currentScreen);
            
            if (currentIndex > 0) {
                let prevScreen = screens[currentIndex - 1];
                
                // Skip screens based on delivery method
                if (prevScreen === 'emailCount' && !session.delivery.includes('email')) {
                    prevScreen = screens[currentIndex - 2];
                }
                if (prevScreen === 'printCount' && !session.delivery.includes('print')) {
                    prevScreen = screens[currentIndex - 2];
                }
                if (prevScreen === 'emailEntry' && !session.delivery.includes('email')) {
                    // skip the email entry screen if email delivery wasn't selected
                    prevScreen = screens[currentIndex - 2];
                }
                
                showScreen(prevScreen);
            }
        }

        function nextStep() {
            const hasEmail = session.delivery.includes('email');
            const hasPrint = session.delivery.includes('print');
            
            const screens = {
                'background': 'people',
                'people': 'delivery',
                'delivery': hasEmail ? 'emailCount' : (hasPrint ? 'printCount' : 'nameEntry'),
                // After choosing how many emails, if there are prints we go to printCount first,
                // otherwise go straight to the email entry screen so the user can enter addresses.
                'emailCount': hasPrint ? 'printCount' : 'emailEntry',
                'printCount': hasEmail ? 'emailEntry' : 'nameEntry',
                // emailEntry now comes before nameEntry
                'emailEntry': 'nameEntry',
                'nameEntry': 'camera',
                'camera': 'payment',
                // show confirmation BEFORE showing receipt so user can verify details
                'payment': 'receipt',
            };
            
            if (screens[currentScreen]) {
                const next = screens[currentScreen];
                // Intercept transition from payment -> receipt to show an order confirmation first
                if (currentScreen === 'payment' && next === 'receipt') {
                    showOrderConfirmation();
                    return;
                }
                showScreen(next);

                if (next === 'emailEntry') {
                    setupEmailInputs();
                } else if (next === 'camera') {
                    initializeCamera();
                } else if (next === 'receipt') {
                    generateReceipt();
                }
            }
        }

        // Background selection
        function loadBackgrounds() {
            loadCategoryTabs();
            loadBackgroundsForCategory(currentCategory);
        }
        
        function loadCategoryTabs() {
            const tabsContainer = document.getElementById('categoryTabs');
            tabsContainer.innerHTML = '';
            
            Object.keys(config.backgroundCategories).forEach(category => {
                const tab = document.createElement('button');
                tab.className = 'category-tab';
                tab.textContent = category;
                tab.onclick = (e) => selectCategory(category, e);
                
                if (category === currentCategory) {
                    tab.classList.add('active');
                }
                
                tabsContainer.appendChild(tab);
            });
        }
        
        function selectCategory(category, event) {
            currentCategory = category;
            
            // Update tab states
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load backgrounds for selected category
            loadBackgroundsForCategory(category);
        }
        
        function loadBackgroundsForCategory(category) {
            const container = document.getElementById('backgroundOptions');
            container.innerHTML = '';

            const backgrounds = config.backgroundCategories[category] || [];
            const enabled = window.enabledBackgrounds || {};

            backgrounds.forEach(bg => {
                if (enabled[String(bg.id)] === false) return; // skip disabled
                const button = document.createElement('button');
                button.className = 'touch-button';
                button.onclick = (e) => selectBackground(bg, e);

                button.innerHTML = `
                    <div style="width: 60px; height: 40px; border-radius: 8px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;">${bg.preview}</div>
                    <div>${bg.name}</div>
                `;

                container.appendChild(button);
            });
        }

        function selectBackground(bg, event) {
            session.background = bg;
            
            // Update preview
            const preview = document.getElementById('preview');
            preview.style.background = 'none';
            
            if (bg.id === 18) {
                showCustomBackgroundInstructions();
            } else if (bg.imageUrl) {
                preview.innerHTML = `<img src="${bg.imageUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'padding: 20px; text-align: center; color: #666;\'>Image Preview</div>';" alt="${bg.name}">`;
            } else {
                const previewContent = bg.fullPreview || bg.preview.replace('width="60" height="40"', 'width="280" height="180"');
                preview.innerHTML = `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; border-radius: 10px; overflow: hidden;">${previewContent}</div>`;
            }
            
            // Update button states
            document.querySelectorAll('#backgroundOptions .touch-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            document.getElementById('nextBtn').disabled = false;
        }

        function showCustomBackgroundInstructions() {
            const preview = document.getElementById('preview');
            preview.innerHTML = "<div style='padding: 20px; text-align: center; color: #000;'>üìã Give this number and the custom image you'd like to the photographer:<br><strong style='font-size: 2rem;'>" + session.customerNumber + "</strong></div>";
        }

        // People counter
        function changePeople(delta) {
            session.people = Math.max(1, Math.min(20, session.people + delta));
            document.getElementById('peopleCount').textContent = session.people;
        }

    function updateTotalBox() {
      const total = calculatePrice(); // assumes you already have calculatePrice()
      document.getElementById('totalAmount').textContent = total.toFixed(2);
    }

    // Update the descriptive price text on the Print Count screen based on operator config
    function updatePrintPriceDisplay() {
        const el = document.getElementById('printPriceDisplay');
        if (!el) return;

        // If both base and additional prices are zero, hide the explanatory text (photos are free)
        const base = Number.isFinite(config.basePrice) ? config.basePrice : 0;
        const add = Number.isFinite(config.additionalPrintPrice) ? config.additionalPrintPrice : 0;

        if (base === 0 && add === 0) {
            el.style.display = 'none';
            el.textContent = '';
            return;
        }

        el.style.display = 'block';

        // Choose friendly phrasing depending on which prices are set
        if (base > 0 && add > 0) {
            el.textContent = `$${base.toFixed(2)} for the first print + $${add.toFixed(2)} for each additional print`;
        } else if (base > 0 && add === 0) {
            el.textContent = `$${base.toFixed(2)} per print`;
        } else if (base === 0 && add > 0) {
            el.textContent = `First print free; additional prints $${add.toFixed(2)} each`;
        } else {
            // fallback ‚Äî show a simple price
            const price = base + (session.printCount > 1 ? (session.printCount - 1) * add : 0);
            el.textContent = `$${price.toFixed(2)}`;
        }
    }


        // Delivery selection
        function toggleDelivery(method) {
            const index = session.delivery.indexOf(method);
            
            if (index === -1) {
                session.delivery.push(method);
            } else {
                session.delivery.splice(index, 1);
            }
            
            document.getElementById('emailBtn').classList.toggle('selected', session.delivery.includes('email'));
            document.getElementById('printBtn').classList.toggle('selected', session.delivery.includes('print'));
            
            document.getElementById('deliveryNext').disabled = session.delivery.length === 0;

	   updateTotalBox()
        }

        // Email counter
        function changeEmails(delta) {
            session.emailCount = Math.max(1, Math.min(config.maxEmails, session.emailCount + delta));
            document.getElementById('emailCountDisplay').textContent = session.emailCount;
        }

        // Print counter
        function changePrints(delta) {
            session.printCount = Math.max(1, Math.min(config.maxPrints, session.printCount + delta));
            document.getElementById('printCountDisplay').textContent = session.printCount;
            // Refresh descriptive pricing (reflects any operator config changes)
            try { updatePrintPriceDisplay(); } catch (e) { /* ignore */ }
            updateTotalBox();
        }

        // Payment selection
        function selectPayment(method) {
            session.payment = method;
            
            document.querySelectorAll('#payment .touch-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            if (method === 'cash') {
                document.getElementById('cashBtn').classList.add('selected');
            } else if (method === 'card') {
                document.getElementById('cardBtn').classList.add('selected');
            } else if (method === 'check') {
                document.getElementById('checkBtn').classList.add('selected');
            }
            
            document.getElementById('paymentNext').disabled = false;
        }

        // Name entry
        document.getElementById('customerName').addEventListener('input', function() {
            session.name = this.value.trim();
            document.getElementById('nameNext').disabled = session.name.length === 0;
        });
        // Add pointer-based caret placement for the name input too (parity & robustness)
        (function(){
            const nameEl = document.getElementById('customerName');
            if (nameEl) {
                nameEl.addEventListener('pointerdown', (ev) => {
                    try {
                        // compute approximate caret index and apply immediately
                        const idx = estimateCaretIndexFromClientX(nameEl, ev.clientX);
                        if (typeof idx === 'number') {
                            try { nameEl.setSelectionRange(idx, idx); } catch (e) {}
                            window._vkDesiredCaret = { el: nameEl, start: idx, end: idx };
                        }
                    } catch (e) { /* ignore */ }
                }, true);
            }
        })();

        // Email entry
        function setupEmailInputs() {
            const container = document.getElementById('emailInputs');
            container.innerHTML = '';
            session.emails = [];
            
            for (let i = 0; i < session.emailCount; i++) {
                const input = document.createElement('input');
                input.type = 'email';
                input.className = 'email-input needs-virtual-keyboard';
                input.placeholder = `Email ${i + 1}`;
                input.addEventListener('input', validateEmails);
                input.addEventListener('focus', () => showVirtualKeyboard(input));
                // pointerdown: immediately calculate and set caret so VK typing won't race with focus timing
                input.addEventListener('pointerdown', (ev) => {
                    try {
                        const idx = estimateCaretIndexFromClientX(input, ev.clientX);
                        if (typeof idx === 'number') {
                            try { input.setSelectionRange(idx, idx); } catch (e) {}
                            // store so insertTextAtCursor honors it immediately
                            window._vkDesiredCaret = { el: input, start: idx, end: idx };
                        }
                    } catch (e) { /* ignore */ }
                }, true);
                // don't hide on individual input blur here; global focusout logic handles hiding so clicks into the keyboard don't close it
                container.appendChild(input);
            }
        }

        function validateEmails() {
            const inputs = document.querySelectorAll('#emailInputs input');
            session.emails = [];
            let allValid = true;
            
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            inputs.forEach(input => {
                const email = input.value.trim();
                
                input.style.borderColor = '';
                input.style.backgroundColor = '';
                
                if (email) {
                    if (emailPattern.test(email)) {
                        session.emails.push(email);
                        input.style.borderColor = '#4CAF50';
                        input.style.backgroundColor = '#f8fff8';
                    } else {
                        allValid = false;
                        input.style.borderColor = '#dc3545';
                        input.style.backgroundColor = '#fff8f8';
                    }
                } else {
                    allValid = false;
                }
            });
            
            document.getElementById('emailNext').disabled = !allValid || session.emails.length !== session.emailCount;
        }

        // Camera
        function takePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const placeholder = document.getElementById('cameraPlaceholder');
            
            if (video.srcObject) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                // Bake the customer number into the photo (centered horizontally, aligned near bottom)
                try {
                    const id = session.customerNumber || '';
                    if (id) {
                        // slightly smaller font than before; scales with image size
                        const fontSize = Math.max(12, Math.round(Math.min(canvas.width, canvas.height) * 0.05));
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        const text = id;
                        const metrics = ctx.measureText(text);
                        const textWidth = metrics.width;
                        const paddingX = Math.round(fontSize * 0.5);
                        const paddingY = Math.round(fontSize * 0.4);
                        const boxWidth = textWidth + paddingX * 2;
                        const boxHeight = fontSize + paddingY * 2;

                        const centerX = Math.round(canvas.width / 2);
                        const marginFromBottom = Math.round(canvas.height * 0.04);
                        const centerY = canvas.height - marginFromBottom - Math.round(boxHeight / 2);
                        const boxX = centerX - Math.round(boxWidth / 2);
                        const boxY = centerY - Math.round(boxHeight / 2);

                        // Background box for contrast
                        ctx.fillStyle = 'rgba(0,0,0,0.45)';
                        ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

                        // Text: stroke then fill for readability
                        ctx.lineWidth = Math.max(1, Math.round(fontSize * 0.06));
                        ctx.strokeStyle = 'rgba(0,0,0,0.6)';
                        ctx.fillStyle = '#ffffff';
                        ctx.strokeText(text, centerX, centerY);
                        ctx.fillText(text, centerX, centerY);
                    }
                } catch (e) {
                    console.warn('Failed to draw customer id on photo', e);
                }

                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                session.photoData = imageData;
                
                video.style.display = 'none';
                placeholder.style.display = 'flex';
                placeholder.innerHTML = `<img src="${imageData}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" alt="Captured Photo">`;
                placeholder.style.background = 'none';
                
                session.photoTaken = true;
                document.getElementById('retakeBtn').style.display = 'flex';
                document.getElementById('cameraNext').disabled = false;
            } else {
                session.photoTaken = true;
                // Show a friendly message but include the customer number so operator can match
                const id = session.customerNumber || '';
                placeholder.innerHTML = `
                    <div style="width:100%;height:100%;position:relative;display:flex;align-items:center;justify-content:center;">
                        <div style="text-align:center; padding: 12px;">üì∏ Photo Captured!<br>Looking great! üòä</div>
                        ${id ? `<div style="position:absolute; left:50%; transform:translateX(-50%); bottom:12px; background: rgba(0,0,0,0.45); color:#fff; padding:6px 12px; border-radius:6px; font-weight:600;">${id}</div>` : ''}
                    </div>
                `;
                placeholder.style.background = '#e8f5e8';
                document.getElementById('retakeBtn').style.display = 'flex';
                document.getElementById('cameraNext').disabled = false;
            }
        }

        function retakePhoto() {
            const video = document.getElementById('cameraVideo');
            const placeholder = document.getElementById('cameraPlaceholder');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');

            // Clear previous snapshot
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            session.photoTaken = false;
            session.photoData = null;
            
            // Restart preview if needed
            if (!cameraStream) {
                initializeCamera();
            }
            
            video.style.display = 'block';
            placeholder.style.display = 'none';
            
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('cameraNext').disabled = true;
        }

        // Receipt generation
        function generateReceipt() {
            const now = new Date();
            const date = now.toLocaleDateString();
            const time = now.toLocaleTimeString();
            
            // Customer copy
            document.getElementById('receiptEvent').textContent = config.eventName;
            document.getElementById('receiptName').textContent = session.name;
            document.getElementById('receiptNumber').textContent = session.customerNumber;
            document.getElementById('receiptDate').textContent = date;
            document.getElementById('receiptTime').textContent = time;
            document.getElementById('receiptPrints').textContent = session.delivery.includes('print') ? session.printCount : '0';
            document.getElementById('receiptEmails').textContent = session.delivery.includes('email') ? session.emailCount : '0';
            document.getElementById('receiptPrice').textContent = calculatePrice().toFixed(2);
            document.getElementById('receiptPayment').textContent = session.payment ? session.payment.toUpperCase() : 'FREE';
            
            // Operator copy
            document.getElementById('opName').textContent = session.name;
            document.getElementById('opCustomerId').textContent = session.customerNumber;
            document.getElementById('opDelivery').textContent = session.delivery.map(d => d.toUpperCase()).join(' + ') || 'N/A';
            document.getElementById('opDate').textContent = date;
            document.getElementById('opTime').textContent = time;
            document.getElementById('opPeople').textContent = session.people;
            document.getElementById('opBackground').textContent = session.background ? session.background.id : 'N/A';
            document.getElementById('opPrints').textContent = session.delivery.includes('print') ? session.printCount : '0';
            document.getElementById('opEmailCount').textContent = session.delivery.includes('email') ? session.emailCount : '0';
            document.getElementById('photoNumber').textContent = String(photoCounter).padStart(3, '0');
            
            if (session.delivery.includes('email')) {
                document.getElementById('opEmailList').innerHTML = session.emails.map(email => `‚Ä¢ ${email}`).join('<br>');
            } else {
                document.getElementById('opEmailList').textContent = 'N/A';
            }
            
            photoCounter++;

            // Populate inline print-confirm area so the receipt screen shows the confirmation menu
            try { showPrintConfirmation(); } catch (e) { /* ignore if not present */ }
        }

        // --- Print confirmation flow (inline on the receipt screen) ---
        function showPrintConfirmation() {
            // populate confirmation fields if present in the DOM (no screen switch)
            const set = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };
            set('confirmEvent', config.eventName || '');
            set('confirmName', session.name || '');
            set('confirmCustomerId', session.customerNumber || '');
            set('confirmDate', new Date().toLocaleDateString());
            set('confirmTime', new Date().toLocaleTimeString());
            set('confirmPeople', session.people || 1);
            set('confirmBackground', session.background ? (session.background.name || session.background.id) : 'N/A');
            set('confirmPrints', session.delivery.includes('print') ? session.printCount : '0');
            set('confirmEmails', session.delivery.includes('email') ? session.emailCount : '0');
            set('confirmTotal', calculatePrice().toFixed(2));
            set('confirmPayment', session.payment ? session.payment.toUpperCase() : 'N/A');
            // preview photo if available
            const previewEl = document.getElementById('confirmPreview');
            if (previewEl) {
                if (session.photoData) previewEl.innerHTML = `<img src="${session.photoData}" style="width:240px;height:180px;object-fit:cover;border-radius:8px;" alt="Photo preview">`;
                else previewEl.innerHTML = '<div style="width:240px;height:180px;display:flex;align-items:center;justify-content:center;background:#f0f0f0;border-radius:8px;color:#666;">No photo</div>';
            }
        }

        function doPrintTicket() {
            // Here we call the existing printReceipt() to simulate sending to printer
            // Ensure receipt fields are populated first
            try { generateReceipt(); } catch (e) { /* ignore */ }
            printReceipt();
            // After printing, remain on the receipt screen. The operator or user may press "New Customer" when ready.
            try { showScreen('receipt'); } catch (e) { /* ignore */ }
        }

        // --- Order confirmation (pre-receipt) flow ---
        function showOrderConfirmation() {
            // Populate only user-entered fields for the pre-receipt confirmation.
            // Use session values when available, otherwise fall back to current DOM inputs so the panel shows the latest typed values.
            const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };

            // Name: prefer session, otherwise read the name input directly
            let name = (session && session.name) ? String(session.name) : '';
            const nameInput = document.getElementById('customerName');
            if ((!name || name.trim() === '') && nameInput) name = nameInput.value || '';

            // People: prefer session, otherwise read the peopleCount element
            let people = (session && typeof session.people === 'number') ? session.people : 1;
            const peopleEl = document.getElementById('peopleCount');
            if (peopleEl) {
                const parsed = parseInt(peopleEl.textContent || peopleEl.value || '', 10);
                if (!isNaN(parsed)) people = parsed;
            }

            // Prints: prefer session, otherwise read the printCountDisplay
            let prints = (session && typeof session.printCount === 'number') ? session.printCount : 0;
            const printEl = document.getElementById('printCountDisplay');
            if (printEl) {
                const parsed = parseInt(printEl.textContent || printEl.value || '', 10);
                if (!isNaN(parsed)) prints = parsed;
            }

            // Payment: prefer session, otherwise check for a selected payment button in the DOM
            let payment = (session && session.payment) ? String(session.payment) : '';
            if (!payment) {
                const payBtn = document.querySelector('#payment .touch-button.selected, .payment-method .touch-button.selected, .touch-button.payment.selected');
                if (payBtn) payment = payBtn.dataset && payBtn.dataset.method ? payBtn.dataset.method : payBtn.textContent.trim();
            }

            // Emails: prefer session.emails, otherwise gather any email inputs currently present
            let emails = Array.isArray(session && session.emails) ? session.emails.slice() : [];
            if (!emails || emails.length === 0) {
                const emailInputs = document.querySelectorAll('#emailInputs input[type="email"], #emailInputs input');
                emailInputs.forEach(i => { if (i && i.value && i.value.trim()) emails.push(i.value.trim()); });
            }

            // Populate the confirm panel (order-specific IDs to avoid collisions with confirmPrint)
            setText('confirmOrderName', name || '‚Äî');
            setText('confirmOrderPeople', String(people));
            // If printing isn't part of delivery, show 0
            const printsShown = (session && Array.isArray(session.delivery) && session.delivery.includes('print')) ? String(prints) : (session && session.delivery ? (session.delivery.includes('print') ? String(prints) : '0') : String(prints));
            setText('confirmOrderPrints', printsShown);
            setText('confirmOrderPayment', payment ? payment.toUpperCase() : 'N/A');

            const emailsEl = document.getElementById('confirmOrderEmails');
            if (emailsEl) {
                if (emails && emails.length) emailsEl.textContent = emails.join(', ');
                else if (session && session.emailCount) emailsEl.textContent = `${session.emailCount} email(s)`;
                else emailsEl.textContent = 'N/A';
            }

            // Populate background and total for the order panel
            const bgEl = document.getElementById('confirmBackground');
            if (bgEl) bgEl.textContent = session.background ? (session.background.name || session.background.id) : 'N/A';

            const totalEl = document.getElementById('confirmTotal');
            if (totalEl) totalEl.textContent = calculatePrice().toFixed(2);

            // Populate preview if available
            const previewEl = document.getElementById('confirmPreview');
            if (previewEl) {
                if (session.photoData) previewEl.innerHTML = `<img src="${session.photoData}" style="width:100%; height:100%; object-fit:cover; display:block;" alt="Photo preview">`;
                else previewEl.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#f0f0f0;color:#666;">No photo</div>';
            }

            showScreen('confirmOrder');
        }

        function confirmOrder() {
            // user confirmed details; finalize order by generating receipt and showing it
            generateReceipt();
            showScreen('receipt');
        }

        // Confirm then pop the print modal (used by the bottom-right navigation Confirm button)
        function confirmAndPopupPrint() {
            // generate and show the receipt first
            generateReceipt();
            showScreen('receipt');
            // show the same print/receipt-sent modal as doPrintTicket
            try { printReceipt(); } catch (e) { console.warn('printReceipt not available', e); }
        }

        function printReceipt() {
            const customModal = document.createElement('div');
            customModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 10000;
            `;
            customModal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px;">
                    <h3 style="margin-top: 0;">üìÑ Receipt Sent!</h3>
                    <p>Receipt sent to printer! Please collect from the printer tray.</p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: #667eea; color: white; border: none; padding: 10px 20px; 
                                   border-radius: 8px; cursor: pointer; font-size: 1rem;">OK</button>
                </div>
            `;
            document.body.appendChild(customModal);
        }

        function resetAllUI() {
            // Reset button selections
            document.querySelectorAll('.touch-button').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
            
            // Reset navigation buttons and next states
            document.querySelectorAll('.nav-button').forEach(btn => btn.disabled = false);
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('deliveryNext').disabled = true;
            document.getElementById('paymentNext').disabled = true;
            document.getElementById('nameNext').disabled = true;
            document.getElementById('emailNext').disabled = true;
            document.getElementById('cameraNext').disabled = true;
            
            // Reset form inputs
            document.getElementById('customerName').value = '';
            document.getElementById('peopleCount').textContent = '1';
            document.getElementById('emailCountDisplay').textContent = '1';
            document.getElementById('printCountDisplay').textContent = '1';
            
            // Reset background preview
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            preview.style.background = 'none';
            
            // Reset camera preview UI (do not stop camera here; allow initializeCamera to handle)
            const placeholder = document.getElementById('cameraPlaceholder');
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            if (placeholder) {
                placeholder.innerHTML = '<span>üì∏ Camera Preview<br>Smile! üòä</span>';
                placeholder.style.background = '#f0f0f0';
                placeholder.style.display = 'flex';
            }
            if (video) {
                video.style.display = 'none';
                video.srcObject = null;
            }
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            document.getElementById('retakeBtn').style.display = 'none';
            
            // Reset email inputs container
            const emailInputs = document.getElementById('emailInputs');
            if (emailInputs) {
                emailInputs.innerHTML = '';
            }
            
            // Reset category to default
            currentCategory = 'Nature';

	   // Reset Total Box
	   updateTotalBox();

               // Refresh print price text in case operator changed pricing
               try { updatePrintPriceDisplay(); } catch (e) { /* ignore */ }
        }

        function startOver() {
            session = {
                background: null,
                people: 1,
                delivery: [],
                emailCount: 1,
                printCount: 1,
                payment: null,
                name: '',
                emails: [],
                customerNumber: null,
                photoTaken: false,
                photoData: null
            };
            
            resetAllUI();
            showScreen('welcome');

            // Restart camera for next customer
            initializeCamera();
        }

        function showHelp() {
            const customModal = document.createElement('div');
            customModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 10000;
            `;
            customModal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px;">
                    <h3 style="margin-top: 0;">üÜò Help is Coming!</h3>
                    <p>An attendant will be with you shortly! Look for someone with a "Photo Helper" badge.</p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: #667eea; color: white; border: none; padding: 10px 20px; 
                                   border-radius: 8px; cursor: pointer; font-size: 1rem;">OK</button>
                </div>
            `;
            document.body.appendChild(customModal);
        }

        function quitSession() {
            session = {
                background: null,
                people: 1,
                delivery: [],
                emailCount: 1,
                printCount: 1,
                payment: null,
                name: '',
                emails: [],
                customerNumber: null,
                photoTaken: false,
                photoData: null
            };
            
            resetAllUI();
            showScreen('welcome');

            // Stop camera when quitting
            stopCamera();
        }

        let idleTimer, countdownTimer;
        let countdownValue = 10;

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            clearInterval(countdownTimer);
              document.getElementById("timeoutModal").style.display = "none";

                        const activeScreens = [
                            "background","people","delivery","emailCount","printCount",
                            "nameEntry","emailEntry","camera","payment",
                            "receipt"
                        ];
            if (activeScreens.includes(currentScreen)) {
               idleTimer = setTimeout(showTimeoutWarning, 50000); // 50s
            }
         }

        function showTimeoutWarning() {
            const modal = document.getElementById("timeoutModal");
            modal.style.display = "flex";
           countdownValue = 10;
           document.getElementById("countdown").textContent = countdownValue;

           countdownTimer = setInterval(() => {
               countdownValue--;
               document.getElementById("countdown").textContent = countdownValue;
               if (countdownValue <= 0) {
                     clearInterval(countdownTimer);
                     quitSession(); // back to welcome
                 modal.style.display = "none";
                }
           }, 1000);
        }

        // Reset timer on activity
        document.addEventListener("mousemove", resetIdleTimer);
        document.addEventListener("click", resetIdleTimer);

        // Accessibility toolbar positioning: avoid blocking important chrome (like the total)
        function updateA11yPosition(screenId) {
            try {
                const toolbar = document.getElementById('a11yToolbar');
                if (!toolbar) return;
                // Place the toolbar bottom-left slightly above bottom controls so it doesn't block buttons
                toolbar.style.left = '12px';
                toolbar.style.right = 'auto';
                toolbar.style.top = 'auto';
                toolbar.style.bottom = '92px';
                toolbar.style.transform = 'none';
            } catch (e) { console.warn('updateA11yPosition failed', e); }
        }

        // Hook into screen changes
        const originalShowScreen = showScreen;
        showScreen = function(screenId) {
            originalShowScreen(screenId);
            resetIdleTimer();
            updateA11yPosition(screenId);
            // Ensure email inputs are prepared any time the email entry screen is shown
            // This covers both forward navigation and cases where the user navigates back/forwards
            // so the screen isn't blank.
            if (screenId === 'emailEntry') {
                try { setupEmailInputs(); } catch (e) { /* ignore if not available */ }
            }
            // Ensure receipt is generated when the receipt screen is shown so fields are always populated
            if (screenId === 'receipt') {
                try { generateReceipt(); } catch (e) { /* ignore */ }
            }
            // Ensure print count screen describes the current pricing
            if (screenId === 'printCount') {
                try { updatePrintPriceDisplay(); } catch (e) { /* ignore */ }
            }
        };
        // Ensure initial position is correct on load
        try { updateA11yPosition(currentScreen); } catch (e) {}

        // Continue button cancels timeout (guard in case the button isn't present)
        (function(){
            const cb = document.getElementById("continueBtn");
            if (!cb) return;
            cb.addEventListener("click", () => {
                try { clearInterval(countdownTimer); } catch (e) {}
                const modal = document.getElementById("timeoutModal"); if (modal) modal.style.display = "none";
                try { resetIdleTimer(); } catch (e) {}
            });
        })();



    </script>
    	<!-- Timeout Modal -->
    <div id="timeoutModal">
	     <div class="modal-content">
	          <h2>‚è≥ Session Timeout</h2>
	          <p>No activity detected please tap the screen to "Continue". Returning to the Welcome screen in 
		<span id="countdown">10</span> seconds...</p>
	</div>
        </div>

    <!-- Configuration Modal -->
    <!-- Password / Operator PIN Modal -->
    <div id="passwordModal" class="config-modal password-modal" role="dialog" aria-modal="true" aria-labelledby="pwdTitle">
        <div class="config-box" id="passwordBox" style="max-width:420px;">
            <button class="password-close" onclick="closePasswordModal()" aria-label="Close operator modal">‚úï</button>
            <h3 id="pwdTitle" style="margin:0;">Operator Access</h3>
            <p style="color:#555; margin-top:8px;">This area is for operators only. If you stumbled upon this, press the red X to exit and continue on.</p>
            <div style="margin-top:12px;">
                <input id="pwdInput" class="needs-virtual-keyboard" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="Enter PIN" maxlength="8" style="width:100%; padding:12px; font-size:1.4rem; box-sizing:border-box;" />
            </div>
            <div id="pwdError" style="color:#c0392b; margin-top:8px; min-height:18px;"></div>
            <div class="cfg-actions">
                <button class="nav-button" onclick="verifyPasswordAndOpenConfig()">Unlock</button>
            </div>
        </div>
    </div>
    <div id="configModal" class="config-modal" role="dialog" aria-modal="true" aria-labelledby="cfgTitle">
        <div class="config-box">
            <h3 id="cfgTitle">Operator Settings</h3>
            <div class="config-grid">
                <div>
                    <label>Event Name<br><input id="cfgEventName" class="needs-virtual-keyboard" type="text" style="width:100%; padding:8px; margin-top:6px;" /></label>
                    <label style="display:block; margin-top:10px;">Base Price ($)<br><input id="cfgBasePrice" class="needs-virtual-keyboard" type="number" step="0.01" min="0" style="width:100%; padding:8px; margin-top:6px;" /></label>
                    <label style="display:block; margin-top:10px;">Additional Print Price ($)<br><input id="cfgAdditionalPrintPrice" class="needs-virtual-keyboard" type="number" step="0.01" min="0" style="width:100%; padding:8px; margin-top:6px;" /></label>
                </div>
                <div>
                    <label>Max Prints<br><input id="cfgMaxPrints" class="needs-virtual-keyboard" type="number" min="1" style="width:100%; padding:8px; margin-top:6px;" /></label>
                    <label style="display:block; margin-top:10px;">Max Emails<br><input id="cfgMaxEmails" class="needs-virtual-keyboard" type="number" min="1" style="width:100%; padding:8px; margin-top:6px;" /></label>
                    <div style="margin-top:12px;">
                        <strong>Payment Methods</strong><br>
                        <label><input id="cfgPay_cash" type="checkbox"> Cash</label>
                        <label style="margin-left:8px;"><input id="cfgPay_card" type="checkbox"> Card</label>
                        <label style="margin-left:8px;"><input id="cfgPay_check" type="checkbox"> Check</label>
                    </div>
                    <div style="margin-top:8px;">
                        <strong>Delivery Methods</strong><br>
                        <label><input id="cfgDel_email" type="checkbox"> Email</label>
                        <label style="margin-left:8px;"><input id="cfgDel_print" type="checkbox"> Print</label>
                    </div>
                </div>
            </div>

            <div style="margin-top:12px;">
                <strong>Backgrounds</strong>
                <div id="cfgUploadArea" style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                    <input id="cfgUploadInput" type="file" accept="image/*" style="flex:1;" />
                    <button id="cfgUploadBtn" class="nav-button" style="padding:8px 12px;">Upload</button>
                </div>
                <div id="cfgUploadList" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;"></div>
                <div id="cfgBackgroundList" style="margin-top:8px;"></div>
            </div>

            <div style="margin-top:18px;">
                <strong>Ticket History (Demo)</strong>
                <div id="cfgTicketHistory" style="max-height:200px; overflow:auto; border:1px solid #eee; padding:8px; border-radius:6px; margin-top:8px; background:#fafafa;">
                    <!-- Ticket rows populated by JS for demo -->
                </div>
            </div>

            <div class="cfg-actions">
                <button class="nav-button" onclick="closeConfigModal()">Cancel</button>
                <button class="nav-button" onclick="applyConfig()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Accessibility controls: font size only (zoom removed)
        (function() {
            const STORAGE_KEY = 'kiosk_access_v1';
            const defaults = { fontScale: 1.0 };
            let state = Object.assign({}, defaults);

            function load() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (!raw) return;
                    const parsed = JSON.parse(raw);
                    if (parsed && typeof parsed === 'object') state = Object.assign({}, defaults, parsed);
                } catch (e) { console.warn('Load accessibility settings failed', e); }
            }

            function save() {
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) { console.warn('Save accessibility failed', e); }
            }

            // Apply font scaling by updating root CSS variables so !important stylesheet rules respond.
            function applyFontScaling() {
                try {
                    // Compute a new base font size from the default 20px scaled by the state
                    const newBase = Math.max(12, Math.round(20 * state.fontScale));
                    const newH1 = Math.round(newBase * 1.6);
                    const newH2 = Math.round(newBase * 1.2);
                    const newH3 = Math.round(newBase * 1.0);
                    const newUI = Math.max(12, Math.round(newBase * 0.9));

                    document.documentElement.style.setProperty('--base-font', newBase + 'px');
                    document.documentElement.style.setProperty('--h1', newH1 + 'px');
                    document.documentElement.style.setProperty('--h2', newH2 + 'px');
                    document.documentElement.style.setProperty('--h3', newH3 + 'px');
                    document.documentElement.style.setProperty('--ui-font', newUI + 'px');
                } catch (e) {
                    console.warn('applyFontScaling failed', e);
                }
            }

            function apply() {
                // Only apply the font scaling; zoom feature removed
                applyFontScaling();
            }

            function clamp() {
                state.fontScale = Math.min(1.8, Math.max(0.7, state.fontScale));
            }

            function incFont() { state.fontScale = +(state.fontScale + 0.1).toFixed(2); clamp(); apply(); save(); }
            function decFont() { state.fontScale = +(state.fontScale - 0.1).toFixed(2); clamp(); apply(); save(); }
            function resetAll() { state = Object.assign({}, defaults); apply(); save(); }

            load(); apply();

            // Wire buttons
            const elFontInc = document.getElementById('a11yFontInc');
            const elFontDec = document.getElementById('a11yFontDec');
            const elReset = document.getElementById('a11yReset');
            const elToggle = document.getElementById('a11yToggle');
            const elPanel = document.getElementById('a11yPanel');

            if (elFontInc) elFontInc.addEventListener('click', incFont);
            if (elFontDec) elFontDec.addEventListener('click', decFont);
            if (elReset) elReset.addEventListener('click', resetAll);

            // Toggle panel visibility behind the accessibility icon
            if (elToggle && elPanel) {
                elToggle.addEventListener('click', () => {
                    const showing = elPanel.style.display === 'block' || elPanel.style.display === 'flex';
                    elPanel.style.display = showing ? 'none' : 'block';
                    elToggle.setAttribute('aria-expanded', String(!showing));
                });
            }

            // Keyboard shortcuts: + to increase font, - to decrease font
            document.addEventListener('keydown', (ev) => {
                if (ev.key === '+' || ev.key === '=' ) {
                    incFont();
                } else if (ev.key === '-' || ev.key === '_') {
                    decFont();
                }
            });
        })();
    </script>
</body>
</html>
```


